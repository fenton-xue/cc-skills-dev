# 编号序列表

## t_order_group_sequence（订单组编号序列表）

**表说明**：用于生成并单组、清关组的编号序列

**完整字段**：

| 字段名      | 类型        | 说明                           | 备注               |
| ----------- | ----------- | ------------------------------ | ------------------ |
| id          | BIGINT      | 主键ID                         | 自增               |
| group_type  | VARCHAR(10) | 组类型                         | VB-并单组，CC-清关组 |
| date_prefix | VARCHAR(8)  | 日期前缀，格式YYYYMMDD          |                    |
| current_seq | INT         | 当前序号                       | 从0开始            |
| version     | INT         | 乐观锁版本号                   | 用于并发控制       |
| create_by   | VARCHAR(128)| 创建人                         |                    |
| create_time | TIMESTAMP   | 创建时间                       | 默认CURRENT_TIMESTAMP |
| last_update_by | VARCHAR(128)| 更新人                        |                    |
| last_update_time | TIMESTAMP | 更新时间                     | 默认CURRENT_TIMESTAMP |

**唯一索引**：
- PRIMARY KEY (id)
- UNIQUE KEY uk_group_type_date (group_type, date_prefix)

**业务逻辑**：
1. 编号格式：{group_type} + {date_prefix} + {4位序号}
   - 示例：VB20251206001（第1个并单组）
   - 示例：CM20251206001（第1个合并清关组）
   - 示例：CS20251206001（第1个拆分清关组）

2. 生成逻辑：
   - 查询序列表：SELECT * FROM t_order_group_sequence WHERE group_type='VB' AND date_prefix='20251213'
   - 若不存在则插入：INSERT INTO t_order_group_sequence (group_type, date_prefix, current_seq, version) VALUES ('VB', '20251213', 0, 0)
   - 乐观锁更新：UPDATE t_order_group_sequence SET current_seq=current_seq+1, version=version+1 WHERE id=? AND version=?
   - 若更新成功，返回编号：VB + 20251213 + 格式化序号(001)
   - 若更新失败，重试（最多3次）

3. 乐观锁机制：
   - 使用version字段防止并发冲突
   - 更新时检查version，不匹配则重试
