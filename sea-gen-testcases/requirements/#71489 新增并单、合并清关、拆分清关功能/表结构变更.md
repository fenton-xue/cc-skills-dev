# #71489 表结构变更

## 变更概述
本需求涉及2个表的字段新增和1个新表创建

## 新增字段

### 1. t_marine_order 表新增字段

| 字段名         | 类型        | 说明                                  |
| -------------- | ----------- | ------------------------------------- |
| merge_group_no | VARCHAR(20) | 并单组编号，格式：VB+YYYYMMDD+4位序号  |

**位置**：在platform_audit_status字段之后

**SQL**：
```sql
ALTER TABLE t_marine_order
ADD COLUMN merge_group_no VARCHAR(20) DEFAULT NULL
        COMMENT '并单组编号，格式：VB+YYYYMMDD+4位序号，如VB20251206001'
        after platform_audit_status;
```

**索引**：
```sql
CREATE INDEX idx_marine_order_merge_group_no ON t_marine_order(merge_group_no);
```

### 2. t_receipt_order 表新增字段

| 字段名                   | 类型        | 说明                                  |
| ------------------------ | ----------- | ------------------------------------- |
| merge_clearance_group_no | VARCHAR(20) | 合并清关组编号，格式：CM+YYYYMMDD+4位序号 |
| split_clearance_group_no | VARCHAR(20) | 拆分清关组编号，格式：CS+YYYYMMDD+4位序号 |

**SQL**：
```sql
ALTER TABLE t_receipt_order
    ADD COLUMN merge_clearance_group_no VARCHAR(20) DEFAULT NULL
        COMMENT '合并清关组编号，格式：CM+YYYYMMDD+4位序号',
    ADD COLUMN split_clearance_group_no VARCHAR(20) DEFAULT NULL
        COMMENT '拆分清关组编号，格式：CS+YYYYMMDD+4位序号';
```

**索引**：
```sql
CREATE INDEX idx_receipt_order_merge_clearance_group_no ON t_receipt_order(merge_clearance_group_no);
CREATE INDEX idx_receipt_order_split_clearance_group_no ON t_receipt_order(split_clearance_group_no);
```

## 新增表

### t_order_group_sequence（编号序列表）

**说明**：用于生成并单、清关组编号

**完整结构**：

| 字段名       | 类型        | 说明                           |
| ------------ | ----------- | ------------------------------ |
| id           | BIGINT      | 主键ID                         |
| group_type   | VARCHAR(10) | 组类型: VB-并单组，CC-清关组   |
| date_prefix  | VARCHAR(8)  | 日期前缀，格式YYYYMMDD          |
| current_seq  | INT         | 当前序号                       |
| version      | INT         | 乐观锁版本号                   |
| create_by    | VARCHAR(128)| 创建人                         |
| create_time  | TIMESTAMP   | 创建时间                       |
| last_update_by | VARCHAR(128)| 更新人                        |
| last_update_time | TIMESTAMP | 更新时间                     |

**SQL**：
```sql
CREATE TABLE IF NOT EXISTS t_order_group_sequence
(
    id               BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
    group_type       VARCHAR(10)  NOT NULL COMMENT '组类型: VB-并单组，CC-清关组',
    date_prefix      VARCHAR(8)   NOT NULL COMMENT '日期前缀，格式YYYYMMDD',
    current_seq      INT          NOT NULL DEFAULT 0 COMMENT '当前序号',
    version          INT          NOT NULL DEFAULT 0 COMMENT '乐观锁版本号',
    create_by        varchar(128) null comment '创建人',
    create_time      timestamp             default CURRENT_TIMESTAMP not null comment '创建时间',
    last_update_by   varchar(128) null comment '更新人',
    last_update_time timestamp             default CURRENT_TIMESTAMP not null comment '更新时间',
    UNIQUE KEY uk_group_type_date (group_type, date_prefix)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4 COMMENT ='订单组编号序列表';
```

## 引用表结构
- t_marine_order：见 `database-designs/公共表设计.md`
- t_receipt_order：见 `database-designs/公共表设计.md`
- t_order_group_sequence：见 `database-designs/编号序列表.md`

## 数据流转规则

### 并单操作
1. 用户选择多个海运单进行并单
2. 生成并单组编号：从t_order_group_sequence获取（group_type='VB'）
3. 将生成的merge_group_no写入所有选中的t_marine_order记录
4. **验证**：多条记录的merge_group_no字段值相同

### 合并清关操作
1. 用户选择多个入库单进行合并清关
2. 生成合并清关组编号：从t_order_group_sequence获取（group_type='CM'）
3. 将生成的merge_clearance_group_no写入所有选中的t_receipt_order记录
4. **验证**：多条记录的merge_clearance_group_no字段值相同

### 拆分清关操作
1. 同一订单内的入库单按供货商分组
2. 为每个供货商组生成拆分清关组编号：从t_order_group_sequence获取（group_type='CS'）
3. 将生成的split_clearance_group_no写入对应供货商的t_receipt_order记录
4. **验证**：同一供货组的入库单split_clearance_group_no相同

## 数据验证规则

### 互斥关系验证
- **合并清关与拆分清关字段互斥**：
  - 一个入库单的merge_clearance_group_no和split_clearance_group_no不能同时有值
  - SQL验证：`merge_clearance_group_no IS NULL OR split_clearance_group_no IS NULL`

### 编号格式验证
- **并单组编号格式**：VB + YYYYMMDD + 4位序号
  - 示例：VB20251206001
  - 正则：`^VB\d{8}\d{4}$`

- **合并清关组编号格式**：CM + YYYYMMDD + 4位序号
  - 示例：CM20251206001
  - 正则：`^CM\d{8}\d{4}$`

- **拆分清关组编号格式**：CS + YYYYMMDD + 4位序号
  - 示例：CS20251206001
  - 正则：`^CS\d{8}\d{4}$`

### 唯一性验证
- 同一组编号内的记录必须是同类型的操作
- 并单操作：只能对海运单（t_marine_order）
- 清关操作：只能对入库单（t_receipt_order）

## 测试要点

### 数据库验证测试点
1. **并单后验证**：
   - 查询t_marine_order表，验证merge_group_no字段已写入
   - 验证多条记录的merge_group_no值相同
   - 验证编号格式：VB + 8位日期 + 4位序号

2. **合并清关后验证**：
   - 查询t_receipt_order表，验证merge_clearance_group_no字段已写入
   - 验证多条记录的merge_clearance_group_no值相同
   - 验证编号格式：CM + 8位日期 + 4位序号

3. **拆分清关后验证**：
   - 查询t_receipt_order表，验证split_clearance_group_no字段已写入
   - 验证同一供货组的记录split_clearance_group_no相同
   - 验证编号格式：CS + 8位日期 + 4位序号

4. **互斥关系验证**：
   - 尝试同时设置merge_clearance_group_no和split_clearance_group_no
   - 验证系统拒绝或清空其中一个
