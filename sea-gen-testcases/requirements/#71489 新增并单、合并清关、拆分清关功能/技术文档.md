# #71489 新增并单、合并清关、拆分清关功能

## 1. 数据模型设计

在 t_receipt_order 表新增三个字段，新增编号序列表

### 1.1  t_marine_order 表新增字段

| 字段名         | 类型        | 说明                                  |
| -------------- | ----------- | ------------------------------------- |
| merge_group_no | VARCHAR(20) | 并单组编号，格式：VB+YYYYMMDD+3位序号 |



### 1.2 t_receipt_order 表新增字段

|                          |             |                                           |
| ------------------------ | ----------- | ----------------------------------------- |
| merge_clearance_group_no | VARCHAR(20) | 合并清关组编号，格式：CM+YYYYMMDD+3位序号 |
| split_clearance_group_no | VARCHAR(20) | 拆分清关组编号，格式：CS+YYYYMMDD+3位序号 |



```
 -- t_receipt_order 表新增字段
ALTER TABLE t_marine_order
ADD COLUMN merge_group_no VARCHAR(20) DEFAULT NULL
        COMMENT '并单组编号，格式：VB+YYYYMMDD+4位序号，如VB20251206001' after platform_audit_status;

-- t_receipt_order 表新增字段
ALTER TABLE t_receipt_order
    ADD COLUMN merge_clearance_group_no VARCHAR(20) DEFAULT NULL
        COMMENT '合并清关组编号，格式：CM+YYYYMMDD+4位序号，如CM20251206001',
    ADD COLUMN split_clearance_group_no VARCHAR(20) DEFAULT NULL
        COMMENT '拆分清关组编号，格式：CS+YYYYMMDD+4位序号，如CS20251206001';

-- 索引
CREATE INDEX idx_marine_order_merge_group_no ON t_marine_order(merge_group_no);
CREATE INDEX idx_receipt_order_merge_clearance_group_no ON t_receipt_order(merge_clearance_group_no);
CREATE INDEX idx_receipt_order_split_clearance_group_no ON t_receipt_order(split_clearance_group_no);
```





### 1.3 编号序列表



```
CREATE TABLE IF NOT EXISTS t_order_group_sequence
(
    id               BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
    group_type       VARCHAR(10)  NOT NULL COMMENT '组类型: VB-并单组 CC清关组',
    date_prefix      VARCHAR(8)   NOT NULL COMMENT '日期前缀，格式YYYYMMDD',
    current_seq      INT          NOT NULL DEFAULT 0 COMMENT '当前序号',
    version          INT          NOT NULL DEFAULT 0 COMMENT '乐观锁版本号',
    create_by        varchar(128) null comment '创建人',
    create_time      timestamp             default CURRENT_TIMESTAMP not null comment '创建时间',
    last_update_by   varchar(128) null comment '更新人',
    last_update_time timestamp             default CURRENT_TIMESTAMP not null comment '更新时间',
    UNIQUE KEY uk_group_type_date (group_type, date_prefix)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4 COMMENT ='订单组编号序列表';
```





### 1.3 业务规则

| 标记类型 | 操作维度 | 编号字段                 | 编号格式      | 说明                                       |
| -------- | -------- | ------------------------ | ------------- | ------------------------------------------ |
| 并单     | 海运单   | merge_group_no           | VB20251206001 | 多个海运单共用同一并单组编号               |
| 合并清关 | 入库单   | merge_clearance_group_no | CM20251206001 | 多个入库单共用同一合并清关组编号           |
| 拆分清关 | 入库单   | split_clearance_group_no | CS20251206001 | 同一订单内入库单按供货商分组，每组一个编号 |

**互斥关系**：

- 合并清关与拆分清关字段互斥（一个入库单的 merge_clearance_group_no 和 split_clearance_group_no 不能同时有值）
- 一个入库单只能属于一个并单组
- 查询优化：直接通过对应字段查询，无需复杂条件判断



## 2. 编号生成方案（序列 + 乐观锁）

### 2.1 生成逻辑



```
1. 查询序列表：SELECT * FROM t_order_group_sequence
                WHERE group_type = '{VB|CM|CS}' AND date_prefix = '20251213'

2. 若不存在则插入：INSERT INTO t_order_group_sequence (group_type, date_prefix, current_seq, version)
                   VALUES ('{type}', '20251213', 0, 0)

3. 乐观锁更新：UPDATE t_order_group_sequence
              SET current_seq = current_seq + 1, version = version + 1
              WHERE id = ? AND version = ?

4. 若更新成功，返回编号：{type} + 20251213 + 格式化序号(001)
   若更新失败，重试（最多3次）
```







## 3.API接口设计文档

接口权限拆分（取消和保存接口拆分）

AN文件并发提示



#### A. 并单接口（3个）

- POST /api/orderGroup/queryMergeBasicInfo 并单基础信息查询
- POST /api/orderGroup/mergeMark 并单标记
- POST /api/orderGroup/mergeManage 并单管理

#### B. 合并清关接口（3个）

-  POST /api/orderGroup/queryClearanceMergeBasicInfo - 合并清关基础信息查询
-  POST /api/orderGroup/clearanceMergeMark - 合并清关标记
-  POST /api/orderGroup/clearanceMergeManage - 合并清关管理

#### C. 拆分清关接口（2个）

-  GET /api/orderGroup/queryClearanceSplitBasicInfo/{orderNo} - 拆分清关基础信息查
-  POST /api/orderGroup/clearanceSplitManage - 拆分清关管理

#### D. 校验接口（2个）

- \11. POST /api/marineOrder/validateOrderModify - 订单修改校验

批量填写货运代理简称

批量填写船公司

列表填写/修改：货运代理简称、目的港、船公司

录入SO：货运代理简称、目的港、船公司、船名航次

订舱结果修改订单信息

海运订单修改订单信息

- /api/shippingSpace/batchEdit
- /api/shippingSpace/saveSoInfo
- /api/marineOrder/shippingOrderModify
- /api/marineOrder/orderModify
- /api/marineOrder/updateAreaInfo 

#### F. 现有接口改造（15个）

-  /api/shippingSpace/queryUnfinishedOrder - 待订舱/订舱中查询（新增查询字段）



```
{
    "isMergeGroup": "是否并单",
    "mergeGroupNo": "并单组编号"
}
```





- /api/shippingSpace/queryAbnormalOrder - 异常待处理查询（新增查询字段）



```
{
    "isMergeGroup": "是否并单",
    "mergeGroupNo": "并单组编号",
}
```





- /api/shippingSpace/queryFinishedOrder - 订舱结果查询（新增查询字段）



```
{
    "isMergeGroup": "是否并单",
    "mergeGroupNo": "并单组编号",
}
```





- /api/queryMarineOrder/marineOrderQuery  -订单列表查询（新增查询字段）



```
{
    "isMergeGroup": "是否并单",
    "isClearanceSplit": "是否拆分清关",
    "isClearanceMerge": "是否合并清关",
    "mergeGroupNo": "并单组编号",
    "clearanceGroupNo": "清关组编号"
}
```





-  api/marineOrder/findMarineOrderById/{orderId} - 订单详情查询（新增字段）



```
{
    "clearanceGroupNo": "清关组编号"
}
```





-  /api/singleQuotation/findSingleQuotationByIdForCost/{quotationId} - 单票费用详情（新增字段）



```
{
    "clearanceGroupNo": "清关组编号"
}
```







- /api/singleQuotation/findSingleQuotationByIdForTariff/{quotationId} - 单票关税详情（新增字段）



```
{
    "clearanceGroupNo": "清关组编号"
}
```





-  api/marineOrderUploadFile/import - 订单导入（校验逻辑）
-  /api/shippingSpace/cancelShippingSpace - 取消订舱（自动移出）
-  /api/marineOrder/assignArea - 分配区域驳回（自动移出）
- api/marineOrder/platoonAudit - 船期分配驳回（自动移出）
- /api/marineOrderOperation/modifyAuditOperation - 修改审核（自动移出）
-  /api/marineOrderOperation/recallProcessQuery - 取消审核（自动移出）
- api/logisticsOrder/selfSupportAdd               （自营排船申请  需要拆分清关）
- /api/marineOrder/checkOrderQuotation        （手动匹配报价 收入报价中的清关费翻倍）

-  /api/anFile/upload - AN文件上传（基于#64950接口改造 增加返回字段和排序）

