# 技术方案-取消订舱_异常操作支持批量操作等相关优化-2026-01-13-1.0

## 一、数据库结构变动

### 1.1 表结构变更

```sql
-- 海运订单表增加字段（以下字段已存在，无需新增）
-- train_flag 字段实际存在于 t_marine_order_attach 表的 train_flag 字段
-- isf_agent_id 字段实际存在于 t_marine_order 表的 isf_agent_id 字段
-- customs_clear_agent_id 字段实际存在于 t_marine_order 表的 customs_clear_agent_id 字段

-- 新增以下字段
ALTER TABLE t_marine_order
  ADD COLUMN departure_port_note VARCHAR(400) NULL COMMENT '起运港备注',
  ADD COLUMN destination_port_note VARCHAR(400) NULL COMMENT '目的港备注',
  ADD COLUMN customs_clear_note VARCHAR(400) NULL COMMENT '清关备注';

-- ISF编号/状态文本 使用isf_flag 字段实际存在于 t_marine_order 表，无需新增 

-- 第二版变更说明：取消订舱时需要记录字段原始值，以便撤回时恢复
-- 需要在订舱日志表（t_shipping_space_operation_log）中增加字段记录取消前的值
-- 若日志表已有记录字段值的字段，则无需新增；若无，需增加以下字段：
-- ALTER TABLE t_shipping_space_operation_log
--   ADD COLUMN train_flag_before TINYINT NULL COMMENT '取消前是否有火车运输',
--   ADD COLUMN isf_agent_id_before BIGINT NULL COMMENT '取消前ISF代理ID',
--   ADD COLUMN isf_flag_before VARCHAR(50) NULL COMMENT '取消前ISF状态',
--   ADD COLUMN customs_clear_agent_id_before BIGINT NULL COMMENT '取消前清关代理ID';

-- 待订舱状态异常记录优化：需要在订舱异常表中增加待展示标记字段
-- ALTER TABLE t_shipping_space_exception
--   ADD COLUMN is_pending_display TINYINT DEFAULT 0 COMMENT '待展示标记：0-正常显示，1-待邮件发送成功后显示';
```





### 1.2 权限数据变更

```sql
-- 订舱管理标签相关权限（类型为按钮 type = 1）
-- 批量添加标签、批量删除标签：父级为"其他操作"菜单（待订舱/订舱中下的其他操作）
INSERT INTO t_menu (PARENT_ID, MENU_NAME, URL, PERMS, ICON, TYPE, ORDER_NUM, CREATE_TIME, MODIFY_TIME)
SELECT
  (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '其他操作' AND PARENT_ID IN (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '待订舱/订舱中')),
  '批量添加标签', NULL, 'bookingCabin:label:batchAdd', NULL, '1', 1, NOW(), NOW()
UNION ALL
SELECT
  (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '其他操作' AND PARENT_ID IN (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '待订舱/订舱中')),
  '批量删除标签', NULL, 'bookingCabin:label:batchDelete', NULL, '1', 2, NOW(), NOW();

-- 批量发订舱邮件相关权限（类型为按钮 type = 1）
-- 父级为"待订舱/订舱中"菜单（订舱管理下的待订舱/订舱中）
  (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '其他操作' AND PARENT_ID IN (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '待订舱/订舱中')),
  '批量添加标签', NULL, 'bookingCabin:label:batchAdd', NULL, '1', 1, NOW(), NOW()
UNION ALL
SELECT
  (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '其他操作' AND PARENT_ID IN (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '待订舱/订舱中')),
  '批量删除标签', NULL, 'bookingCabin:label:batchDelete', NULL, '1', 2, NOW(), NOW();

-- 批量发订舱邮件相关权限（类型为按钮 type = 1）
-- 父级为"待订舱/订舱中"菜单（订舱管理下的待订舱/订舱中）
  (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '其他操作' AND PARENT_ID IN (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '待订舱/订舱中')),
  '批量添加标签', NULL, 'bookingCabin:label:batchAdd', NULL, '1', 1, NOW(), NOW()
UNION ALL
SELECT
  (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '其他操作' AND PARENT_ID IN (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '待订舱/订舱中')),
  '批量删除标签', NULL, 'bookingCabin:label:batchDelete', NULL, '1', 2, NOW(), NOW();

-- 批量发订舱邮件相关权限（类型为按钮 type = 1）
-- 父级为"待订舱/订舱中"菜单（订舱管理下的待订舱/订舱中）
INSERT INTO t_menu (PARENT_ID, MENU_NAME, URL, PERMS, ICON, TYPE, ORDER_NUM, CREATE_TIME, MODIFY_TIME)
SELECT
  (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '待订舱/订舱中' AND PARENT_ID IN (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '订舱管理')),
  '批量发订舱邮件', NULL, 'bookingCabin:batchSendBookingMail', NULL, '1', 3, NOW(), NOW();

-- 编辑标签、查看标签：父级为"订单流程明细"菜单（订舱管理下的订单流程明细）
INSERT INTO t_menu (PARENT_ID, MENU_NAME, URL, PERMS, ICON, TYPE, ORDER_NUM, CREATE_TIME, MODIFY_TIME)
SELECT
  (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '订单流程明细' AND PARENT_ID IN (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '订舱管理')),
  '编辑标签', NULL, 'bookingCabin:label:edit', NULL, '1', 4, NOW(), NOW()
UNION ALL
SELECT
  (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '订单流程明细' AND PARENT_ID IN (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '订舱管理')),
  '查看标签', NULL, 'bookingCabin:label:view', NULL, '1', 5, NOW(), NOW();

-- 批量取消订舱相关权限（类型为按钮 type = 1）
-- 父级为"批量取消订舱"菜单（订舱结果下的批量取消订舱）
INSERT INTO t_menu (PARENT_ID, MENU_NAME, URL, PERMS, ICON, TYPE, ORDER_NUM, CREATE_TIME, MODIFY_TIME)
SELECT
  (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '批量取消订舱' AND PARENT_ID IN (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '订舱结果')),
  '批量取消', NULL, 'bookingCabin:batchCancel:direct', NULL, '1', 6, NOW(), NOW()
UNION ALL
SELECT
  (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '批量取消订舱' AND PARENT_ID IN (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '订舱结果')),
  '发送取消邮件', NULL, 'bookingCabin:batchCancel:sendMail', NULL, '1', 7, NOW(), NOW();

-- 批量取消订舱相关权限（类型为按钮 type = 1）
-- 父级为"批量取消"菜单（异常待处理下的批量取消）
INSERT INTO t_menu (PARENT_ID, MENU_NAME, URL, PERMS, ICON, TYPE, ORDER_NUM, CREATE_TIME, MODIFY_TIME)
SELECT
  (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '批量取消' AND PARENT_ID IN (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '异常待处理')),
  '批量取消', NULL, 'bookingCabin:batchCancel:direct', NULL, '1', 8, NOW(), NOW()
UNION ALL
SELECT
  (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '批量取消' AND PARENT_ID IN (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '异常待处理')),
  '发送取消邮件', NULL, 'bookingCabin:batchCancel:sendMail', NULL, '1', 9, NOW(), NOW();

-- 批量忽略异常相关权限（类型为按钮 type = 1）
-- 父级为"异常待处理"菜单（订舱管理下的异常待处理）
INSERT INTO t_menu (PARENT_ID, MENU_NAME, URL, PERMS, ICON, TYPE, ORDER_NUM, CREATE_TIME, MODIFY_TIME)
SELECT
  (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '异常待处理' AND PARENT_ID IN (SELECT MENU_ID FROM t_menu WHERE MENU_NAME = '订舱管理')),
  '批量忽略异常', NULL, 'bookingCabin:batchIgnore:abnormal', NULL, '1', 10, NOW(), NOW();
```


```
订舱管理
├── 待订舱/订舱中
│   ├── 批量发订舱邮件 (bookingCabin:batchSendBookingMail)
│   └── 其他操作
│       ├── 批量添加标签 (bookingCabin:label:batchAdd)
│       └── 批量删除标签 (bookingCabin:label:batchDelete)
├── 订舱结果
│   └── 批量取消订舱
│       ├── 批量取消 (bookingCabin:batchCancel:direct)
│       └── 发送取消邮件 (bookingCabin:batchCancel:sendMail)
├── 订单流程明细
│   ├── 编辑标签 (bookingCabin:label:edit)
│   └── 查看标签 (bookingCabin:label:view)
└── 异常待处理
    ├── 批量取消
    │   ├── 批量取消 (bookingCabin:batchCancel:direct)
    │   └── 发送取消邮件 (bookingCabin:batchCancel:sendMail)
    └── 批量忽略异常 (bookingCabin:batchIgnore:abnormal)
```

**说明**：
- 以上SQL语句需要在订舱管理菜单下添加按钮权限
- PARENT_ID 通过子查询获取对应父菜单的 MENU_ID（使用 MENU_NAME 查询，更加通用）
- TYPE = '1' 表示按钮类型
- PERMS 字段为权限标识，用于 Shiro 权限校验
- ORDER_NUM 用于按钮排序
- 权限添加后，需要在角色管理中将相应权限分配给对应角色（通过 t_role_menu 表关联）
- 使用 UNION ALL 合并多条 INSERT 语句，确保在同一个事务中执行

### 1.3 数据流转说明

1. **新增字段的数据来源**：
   - `train_flag`（是否有火车运输）：用户填写，存储在 `t_marine_order_attach` 表
   - `isf_agent_id`（ISF代理简称）：用户填写，存储在 `t_marine_order` 表
   - `isf_flag`（ISF）：用户填写，下拉选择（已提供/未提供），存储在 `t_marine_order` 表
   - `customs_clear_agent_id`（清关代理简称）：用户填写，存储在 `t_marine_order` 表
   - `departure_port_note`、`destination_port_note`、`customs_clear_note`：用户在物流备注弹窗填写

2. **字段清空场景**：
   - 订单取消订舱时：`train_flag`、`isf_agent_id`、`isf_flag`、`customs_clear_agent_id`清空
   - 订单重新申请时：`train_flag`、`isf_agent_id`、`isf_flag`、`customs_clear_agent_id`清空
   - 撤回取消订舱时：`train_flag`、`isf_agent_id`、`isf_flag`、`customs_clear_agent_id`还原

3. **历史数据处理**：
   - 线上已有的`logistics_note`（物流备注）字段值需要业务进行拆分
   - 新增字段默认值为NULL

---

## 二、需求实现

### 一、订舱邮件模版内容调整

#### 1.1 模块总结
调整订舱邮件中托书备注的默认带出内容，过滤掉海运保险相关内容，支持托书备注和其他备注一键清除功能。

#### 1.2 需求点拆解

| 序号 | 场景 | 粒度 | 需求点 | 其他说明 |
|------|------|------|--------|----------|
| 1.2.1 | 发送订舱邮件时 | 页面展示 | 托书备注默认内容调整 | 第2条海运保险不带出，序号自动调整 |
| 1.2.2 | 编辑托书备注时 | 点击操作 | 托书备注一键清除 | 输入框有值时显示删除图标，点击可清空 |
| 1.2.3 | 编辑其他备注时 | 点击操作 | 其他备注一键清除 | 输入框有值时显示删除图标，点击可清空 |

#### 1.3 需求点实现方案

**1.3.1 托书备注默认内容调整**

修改`ShippingSpaceSendMailHelper.buildBookingNote()`方法（第2241行），在特殊产品说明处理逻辑中修改特殊产品说明处理逻辑。当前方法会遍历特殊产品说明列表并生成序号，现在需要增加过滤逻辑，判断特殊产品类型是否为海运保险（通过insuranceFlag字段判断），如果是则跳过该条目，不计入序号计数。修改后调用方无需感知变化，生成托书备注时自动过滤海险相关内容。此修改会影响托书备注生成功能，但不涉及数据库结构变更，风险较低。

**1.3.2 托书备注和其他备注一键清除**

前端实现删除图标显示和点击逻辑，后端`ShippingSpaceController.singleSendMail()`方法（第159行）和`ShippingSpaceController.batchSendMail()`方法（第170行）需支持接收空值和NULL值，确保前端传入空字符串时能正确更新数据库字段为NULL或空字符串。此修改不影响其他功能模块，但需注意空值处理的一致性。

#### 1.4 其他注意事项
- 后端需确保托书备注和其他备注字段支持NULL值和空字符串的更新
- 序号调整逻辑需考虑多语言场景，不同语言的序号显示格式可能不同
- 修改`getMailBaseInfo()`方法时需注意不要影响其他调用方的逻辑
- 一键清除功能需考虑数据回显问题，清除后需刷新页面或更新前端状态

---

### 二、录入SO增加字段

#### 2.1 模块总结
在录入SO弹窗中增加"是否有火车运输"字段，仅对美国、加拿大非自发订单显示并进行必填校验。

#### 2.2 需求点拆解

| 序号 | 场景 | 粒度 | 需求点                        | 其他说明                                                              |
|------|------|------|----------------------------|-------------------------------------------------------------------|
| 2.2.1 | 打开录入SO弹窗时 | 页面展示+接口调用 | 录入SO弹窗根据国别和订单类型展示是否有火车运输字段 | 后端返回国别和订单类型字段，前端判断美国、加拿大非自发订单显示，欧日订单不显示                           |
| 2.2.2 | 点击保存按钮时 | 点击操作 | 保存是否有火车运输并进行必填校验           | 接收trainFlag参数，更新t_marine_order_attach表，美国、加拿大非自发订单必填，若未选择红字提示"请选择" |
| 2.2.3 | 导入SO时 | 点击操作 | 导入SO支持是否有火车运输              | Excel模版增加该字段，导入时校验并保存                                             |

#### 2.3 需求点实现方案

**2.3.1 录入SO弹窗根据国别和类型展示字段**

前端实现，根据后端返回的orderCountry和type字段判断是否显示"是否有火车运输"字段。判断逻辑：if (orderCountry in ['美国', '加拿大'] && type = '非自发') { 显示字段 } else { 不显示字段 }。前端需在弹窗打开时调用接口获取数据，根据返回数据动态显示或隐藏该字段。此修改为纯前端修改，不涉及后端逻辑。

**2.3.2 保存是否有火车运输并进行必填校验**

修改`ShippingSpaceController.saveSoInfo()`方法（第326行），接收trainFlag参数，调用Service层更新t_marine_order_attach表的train_flag字段。在保存方法中增加校验逻辑，判断订单是否为美国或加拿大的非自发订单，若trainFlag为null则抛出业务异常，提示"请选择是否有火车运输"。Service层需增加参数校验和处理，将前端传入的布尔值转换为数据库存储的TINYINT类型。此修改会影响录入SO保存功能，需确保与现有保存逻辑兼容。

**2.3.3 导入SO支持是否有火车运输**

修改导入SO的Excel模版，在模版中增加"是否有火车运输"字段，选项为：true、false(错误：如何不是true、false，报错)。修改`ShippingSpaceController.importSoInfo()`方法（第338行），解析Excel中的trainFlag字段，转换为布尔值后调用保存逻辑。导入时同样需要进行必填校验和格式校验。此修改会影响导入SO功能，需同步更新模版下载和上传解析逻辑。

#### 2.4 其他注意事项
- 需检查是否有其他涉及SO录入的地方，目前已知：录入SO、导入SO
- 校验逻辑需根据国别和订单类型动态调整，美国和加拿大非自发订单需要校验，否则不需要校验
- 导入SO时需校验字段格式是否为有效的布尔值
- 导入失败原因，需放在excel最左侧，再返回给用户下载，只返回错误数据，正确数据执行成功
- 修改saveSoInfo方法时需注意不要影响其他调用方的逻辑

---

### 三、订舱详情页字段调整

#### 3.1 模块总结
根据不同国别和系统类型，在订舱详情页动态展示和编辑不同字段，包括是否有火车运输、ISF代理简称、ISF、清关代理简称等，并支持取消订舱和重新申请时清空这些字段。

#### 3.2 需求点拆解

| 序号 | 场景 | 粒度 | 需求点 | 其他说明                                              |
|------|------|------|--------|---------------------------------------------------|
| 3.2.1 | 打开订舱详情页时 | 页面展示 | B2B美国、加拿大订单展示字段 | 增加：是否有火车运输、ISF代理简称(如果没有【委托ISF申报】服务不展示)、ISF、清关代理简称 |
| 3.2.2 | 打开订舱详情页时 | 页面展示 | 3PL、OSJ美国、加拿大订单展示字段 | 增加：是否有火车运输、ISF、清关代理简称                             |
| 3.2.3 | 打开订舱详情页时 | 页面展示 | 德国、英国、日本订单展示字段 | 增加：清关代理简称                                         |
| 3.2.4 | 点击船名航次字段的删除图标时 | 点击操作 | 船名航次一键清空 | 支持一键清空船名航次字段，清空后需录入新的值，保存时必填校验              |
| 3.2.5 | 取消订舱操作时 | 点击操作 | 取消订舱清空四个字段 | 清空是否有火车运输、ISF代理简称、ISF、清关代理简称                      |
| 3.2.6 | 重新申请操作时 | 点击操作 | 重新申请清空四个字段 | 清空是否有火车运输、ISF代理简称、ISF、清关代理简称                      |
| 3.2.7 | 撤回取消订舱操作时 | 点击操作 | 撤回取消订舱还原四个字段 | 还原是否有火车运输、ISF代理简称、ISF、清关代理简称                      |
| 3.2.8 | 订舱详情页保存时 | 页面展示 | 订舱日志记录字段变更 | 记录新增字段的变更到订舱日志表                                   |
| 3.2.9 | 保存时 | 点击操作 | ISF代理简称校验 | 委托ISF申报的订单才显示该字段，否则提示刷新                           |
| 3.2.10 | 保存时 | 点击操作 | 字段校验逻辑调整 | 录入ATD时，ISF相关字段不参与海运前校验，是否有火车运输需参与校验               |

#### 3.3 需求点实现方案

**3.3.1 B2B美国、加拿大订单展示字段**

修改`MarineOrderController.findShippingSpaceMarineOrderById()`方法（第407行），判断订单国别为美国或加拿大且为非自发订单时，返回trainFlag、isfAgentId、isfFlag、customsClearAgentId。判断逻辑从`MarineOrder`表的orderCountry字段获取国别，从orderSource获取来源系统，从type获取订单类型判断。返回的字段值从对应数据库字段获取。此修改会影响订舱详情页的数据展示，需确保字段值的正确性。

**3.3.2 3PL、OSJ美国、加拿大订单展示字段**

修改`MarineOrderController.findShippingSpaceMarineOrderById()`方法（第407行），判断订单系统为3PL或OSJ、国别为美国或加拿大且为非自发订单时，返回trainFlag、isfFlag、customsClearAgentId，不返回isfAgentId字段。此修改与3.3.1类似，但返回字段略有不同，需在接口中增加条件判断逻辑。

**3.3.3 德国、英国、日本订单展示字段**

修改`MarineOrderController.findShippingSpaceMarineOrderById()`方法（第407行），判断订单国别为德国、英国或日本且为非自发订单时，返回customsClearAgentId。此修改返回字段最少，仅涉及清关代理简称字段。

**3.3.4 船名航次一键清空**

前端实现删除图标显示和点击逻辑，后端`MarineOrderController.shippingOrderModify()`方法（第446行）已支持接收空值，无需修改。前端传入空字符串时，后端将其转换为NULL更新到数据库。船名航次为必填字段，一键清空后需录入新的值，保存时进行必填校验。此修改为纯前端修改，不影响后端逻辑。

**3.3.5 取消订舱清空四个字段**

修改`ShippingSpaceController.cancelShippingSpace()`方法，在取消订舱逻辑中，增加更新t_marine_order_attach表和t_marine_order表的语句，将train_flag、isf_agent_id、isf_flag、customs_clear_agent_id四个字段置空。更新逻辑与取消订舱的现有事务处理放在一起，确保数据一致性。此修改会影响取消订舱功能，需注意事务边界。说明：已订舱的取消需清空，其他状态字段原本就是空

**3.3.6 重新申请清空四个字段**

修改`MarineOrderController.updateByPrimaryKey()`方法，优化MyBatis-Plus的update方法，确保字段值为NULL时也能正确更新到数据库。重新申请功能通过 `@ReapplyClearFiled(clear = true)` 注解自动处理，`train_flag`、`isf_agent_id`、`isf_flag`、`customs_clear_agent_id` 字段在重新申请时会自动清空，需确保updateByPrimaryKey方法能正确处理NULL值更新。

**3.3.7 撤回取消订舱还原四个字段**

修改`ShippingSpaceInfoServiceImpl.completeRevokeCanceledOrder()`方法（第1902行），在撤回取消订舱逻辑中，将train_flag、isf_agent_id、isf_flag、customs_clear_agent_id四个字段还原为取消前的值。还原逻辑如下：

1. **取消订舱时保存原始数据**：
   - 修改`ShippingSpaceStatusChange.cancelShippingSpace()`方法（第66行），在保存SO数据时，同时保存`MarineOrderAttach`表的完整数据到`shipping_order_data`字段
   - `shipping_order_data`字段存储格式为JSON，包含`MarineOrder`和`MarineOrderAttach`两个对象的数据

2. **撤回取消时还原数据**：
   - 修改`ShippingSpaceSoInfoHelper.restoreBeforeMarineOrderInfo()`方法（第83行），增加还原`isfAgentId`字段的逻辑
   - 新增还原`trainFlag`字段的逻辑，从`shipping_order_data`中解析出`MarineOrderAttach`数据并更新到数据库
   - `customsClearAgentId`和`isfFlag`字段已在现有逻辑中还原，无需修改

3. **数据流转**：
   - 取消订舱时：`ShippingSpaceStatusChange.shippingOrderData`保存完整的`MarineOrder`和`MarineOrderAttach`数据
   - 撤回取消时：从`shipping_order_data`解析数据，分别更新`t_marine_order`表和`t_marine_order_attach`表

此修改会影响撤回取消订舱功能，需注意事务边界，确保数据一致性。

**3.3.8 订舱日志记录字段变更**

修改`MarineOrderController.shippingOrderModify()`方法（第446行）的保存逻辑，在保存前记录原有值，保存后对比新旧值，将新增的四个字段纳入变更记录范围，记录到订舱日志表。对比逻辑需要获取保存前的原始值，然后与保存后的值进行比较，将有变化的字段及其新旧值记录到日志表中。此修改会影响订舱日志的完整性，需确保对比逻辑的正确性。

录入SO(`ShippingSpaceController.editSoInfo()`方法，第338行)和导入SO(`ShippingSpaceController.importSoInfo()`方法，第350行)已有日志记录功能，分别在第2012行和第2121行调用`shippingSpaceOperationService.insertEditSoShippingSpaceInfoOperation(logDataList)`方法记录日志，无需额外修改。

**3.3.9 ISF代理简称校验**

在`MarineOrderController.shippingOrderModify()`方法（第446行）中增加校验逻辑，判断订单是否为委托ISF申报的订单，若不是且isfAgentId有值，则抛出业务异常提示"该订单无需填写ISF代理简称，请刷新页面"。校验逻辑在保存前执行，确保数据的有效性。此修改会影响保存功能的校验逻辑。

**3.3.10 字段校验逻辑调整**

修改`MarineOrderController.shippingOrderModify()`方法（第446行）的校验逻辑，当actualDepartureTime（ATD）有值时，isfAgentId、isfFlag、customsClearAgentAbbr不参与海运前必填校验，但trainFlag仍需参与校验。校验逻辑需要根据ATD字段是否有值来动态调整校验规则。此修改会影响保存功能的校验逻辑，需确保规则调整的正确性。

#### 3.4 其他注意事项
- 校验逻辑和展示逻辑需根据系统和国别不同动态调整，需建立清晰的判断逻辑
- 订舱日志记录规则需保持不变，兼容新增字段的记录
- 修改cancelShippingSpace方法时需注意事务处理，确保数据一致性
- 修改updateByPrimaryKey方法时需确保MyBatis-Plus能正确处理NULL值更新
- 撤回取消订舱时需从订舱日志或历史记录表中获取取消前的值进行还原
- ISF代理简称的选项需从ISF代理表中获取有效的代理数据
- 清关代理简称的选项需从清关代理表中获取有效的代理数据

---

### 四、物流备注功能调整

#### 4.1 模块总结
将原有的物流备注拆分为"起运港备注"、"清关备注"、"目的港备注"三个独立字段，支持在订舱管理、海运订单管理、船期分配管理等多个入口编辑和展示。

#### 4.2 需求点拆解

| 序号 | 场景 | 粒度 | 需求点 | 其他说明 |
|------|------|------|--------|----------|
| 4.2.1 | 打开物流备注弹窗时 | 页面展示 | 物流备注弹窗根据订单类型显示不同字段 | 非自发订单显示3个字段（起运港备注、清关备注、目的港备注），自发订单显示2个字段（清关备注、目的港备注），local订单显示1个字段（目的港备注），各400字符 |
| 4.2.2 | 点击物流备注按钮时 | 点击操作 | 订舱管理、海运订单管理、船期分配管理入口编辑物流备注 | 三个入口调用同一个logisticsNoteModify接口保存三个备注字段 |
| 4.2.3 | 待订舱/订舱中、订舱结果列表 | 页面展示 | 订舱列表显示起运港备注 | 最多显示3行，超出显示省略号，鼠标移入气泡显示完整信息 |
| 4.2.4 | 发船审核/审核结果列表 | 页面展示 | 船期分配管理列表显示三个字段 | 去除原物流备注，分为3个字段显示 |
| 4.2.5 | 点击下载按钮时 | 点击操作 | 船期分配管理列表下载三个字段 | 下载时包含起运港备注、清关备注、目的港备注 |
| 4.2.6 | 海运订单管理列表 | 页面展示 | 海运订单列表显示三个字段 | 去除物流备注，增加3个字段到字段设置中 |
| 4.2.7 | 点击导出按钮时 | 点击操作 | 海运订单列表导出三个字段 | 导出时包含起运港备注、清关备注、目的港备注 |
| 4.2.8 | 陆运订单管理列表 | 页面展示 | 陆运订单列表显示目的港备注 | 去除物流备注，改显示为目的港备注 |
| 4.2.9 | 点击导出按钮时 | 点击操作 | 陆运订单列表导出目的港备注 | 导出时包含目的港备注 |
| 4.2.10 | 订单详情页 | 页面展示 | 订单详情页显示三个字段 | 无值的字段不显示，输入框置灰 |
| 4.2.11 | 订单详情页右上角 | 页面展示 | 订单详情页增加编辑按钮 | 增加"物流备注"编辑按钮，点击打开物流备注弹窗 |
| 4.2.12 | 上线前 | 数据处理 | 历史物流备注数据迁移 | 将线上logistics_note字段值拆分到三个新字段 |

#### 4.3 需求点实现方案

**4.3.1 物流备注弹窗根据订单类型显示不同字段**

前端实现，根据订单类型动态显示不同字段：
- 非自发订单：显示起运港备注、清关备注、目的港备注（3个字段）
- 自发订单：显示清关备注、目的港备注（2个字段）
- local订单：显示目的港备注（1个字段）

各字段最大400字符限制，前后空格自动去除。弹窗布局需要根据订单类型动态调整，输入框上下排列，每个输入框有对应标签。前端需根据订单的type字段判断订单类型，动态控制字段的显示和隐藏。此修改为纯前端修改，不涉及后端逻辑，但需要后端保存接口配合。

**4.3.2 物流备注保存接口**

修改`ShippingSpaceController.logisticsNoteModify()`方法（第404行），接收departurePortNote、destinationPortNote、customsClearNote参数，更新t_marine_order表。订舱管理、海运订单管理、船期分配管理都调用同一个logisticsNoteModify接口保存物流备注。保存前需进行参数校验，包括字符长度限制（400字符）和前后空格去除。此接口为修改现有接口，不影响现有功能。

**4.3.3 订舱列表显示起运港备注**

修改`ShippingSpaceController.queryUnfinishedOrder()`方法（第59行）和`queryFinishedOrder()`方法（第66行），返回departurePortNote字段，去除logisticsNote字段。前端限制显示3行，超出显示省略号，鼠标移入显示完整内容。字段值从数据库departure_port_note字段获取。此修改会影响列表展示的数据内容。

**4.3.4-4.3.5 船期分配管理列表显示和下载三个字段**

船期分配管理列表（发船审核列表、审核结果列表）的显示和下载功能通过下载中心实现。修改对应的导出VO类（如`CommonPlatoonExportVO`、`CommonAssignExportVO`等），增加`departurePortNote`、`destinationPortNote`、`customsClearNote`三个字段，去除`logisticsNote`字段。修改下载中心的导出逻辑，下载Excel时包含这三个字段。字段值从数据库对应字段获取。此修改会影响船期分配管理列表和下载功能的数据内容。

**4.3.6-4.3.7 海运订单列表显示和导出三个字段**

修改`MarineOrderController.marineOrderQuery()`方法，返回`departurePortNote`、`destinationPortNote`、`customsClearNote`三个字段，将这三个字段添加到字段设置选项中。修改`MarineOrderQueryController.orderDownload()`方法（第230行），在导出逻辑中包含这三个字段。修改对应的导出VO类（如`MarineOrderExportVO`），增加这三个字段。字段值从数据库对应字段获取。此修改会影响海运订单列表和导出功能的数据内容。

**4.3.8-4.3.9 陆运订单列表显示和导出目的港备注**

修改陆运订单管理列表查询接口，返回destinationPortNote字段，去除logisticsNote字段。修改陆运订单导出接口，在导出逻辑中包含destinationPortNote字段，去除logisticsNote字段。修改对应的导出VO类，增加destinationPortNote字段。字段值从数据库destination_port_note字段获取。此修改会影响陆运订单列表和导出功能的数据内容。

**4.3.10-4.3.11 订单详情页显示和编辑三个字段**

修改`MarineOrderController.findShippingSpaceMarineOrderById()`方法（订舱详情，第407行）和`findMarineOrderById()`方法（海运订单详情，第372行），返回departurePortNote、destinationPortNote、customsClearNote三个字段，若字段值为空则不返回该字段，前端不显示空字段。前端在订单详情页右上角增加"物流备注"编辑按钮，点击调用`ShippingSpaceController.logisticsNoteModify()`方法（第404行）保存。此修改会影响订单详情页的数据展示和编辑功能。

**4.3.12 历史物流备注数据迁移**

编写数据迁移脚本，将线上t_marine_order表的logistics_note字段值拆分到departure_port_note、destination_port_note、customs_clear_note三个字段。迁移规则需业务确认，示例脚本可将logistics_note全部迁移到departure_port_note。迁移前需备份数据，迁移后需验证数据正确性。此修改仅在系统升级时执行一次，不影响日常功能。

#### 4.4 其他注意事项
- 三个字段不必填，前后空格需去除，需在保存时进行trim处理
- 历史数据迁移需业务确认拆分规则，建议先在测试环境验证
- 导入功能需支持三个字段的追加或覆盖导入（错误：和下面的方案核对）
- 修改列表查询接口时需注意分页性能，避免N+1查询问题
- 下载和导出功能需注意Excel格式和数据长度限制
- 前端显示时需处理特殊字符转义，防止XSS攻击

---

### 五、订舱模块支持添加/删除标签功能

#### 5.1 模块总结
在订舱管理模块支持批量添加和删除订单标签，与海运订单管理保持标签数据同步，并增加权限控制（编辑标签、查看标签权限）。

#### 5.2 需求点拆解

| 序号 | 场景 | 粒度 | 需求点 | 其他说明 |
|------|------|------|--------|----------|
| 5.2.1 | 待订舱/订舱中、订舱结果列表 | 页面展示 | 待订舱/订舱中、订舱结果增加批量添加标签按钮 | 【其他操作】下增加【批量添加标签】按钮 |
| 5.2.2 | 待订舱/订舱中、订舱结果列表 | 页面展示 | 待订舱/订舱中、订舱结果增加批量删除标签按钮 | 【其他操作】下增加【批量删除标签】按钮 |
| 5.2.3 | 权限管理时 | 点击操作 | 系统权限菜单增加编辑标签、查看标签 | 订舱管理 > 订单流程明细下增加子菜单：编辑标签、查看标签 |
| 5.2.4 | 勾选订单后点击批量添加标签 | 点击操作 | 批量添加标签功能 | 打开编辑标签弹窗，保存时判断用户权限 |
| 5.2.5 | 打开订舱详情页时 | 页面展示 | 订舱详情页显示标签 | 显示位置与海运订单一致，可支持编辑 |
| 5.2.6 | 标签编辑时 | 数据处理 | 标签数据同步 | 订舱管理和海运订单管理从同一个数据源获取标签，添加和移除都同步 |
| 5.2.7 | 选择标签后点击批量删除标签 | 点击操作 | 批量删除标签功能 | 先选择标签查询订单，再勾选订单删除 |
| 5.2.8 | 保存标签时 | 点击操作 | 编辑标签权限校验 | 判断用户是否有编辑标签权限，若无则提示"无功能权限" |
| 5.2.9 | 打开详情页或列表时 | 页面展示 | 查看标签权限校验 | 判断用户是否有查看标签权限，若无则不显示标签 |

#### 5.3 需求点实现方案

**5.3.1-5.3.2 前端按钮添加**

前端实现，在待订舱/订舱中列表和订舱结果列表的【其他操作】下拉菜单中增加【批量添加标签】和【批量删除标签】按钮。按钮点击触发相应的弹窗或操作流程。此修改为纯前端修改，不涉及后端逻辑。

**5.3.3 权限菜单配置**

在订舱管理 > 订单流程明细下增加子菜单：编辑标签和查看标签，配置相应的权限标识。权限标识需要在Shiro配置文件中定义，与Controller方法的权限注解对应。此修改影响权限管理功能，需与系统管理员确认权限配置。

**5.3.4 批量添加标签功能**

新增`ShippingSpaceController.batchAddLabel()`方法（需新增接口），调用`LabelInfoService.insetOrderLabelConn()`方法保存标签关系，保存前判断用户是否有编辑标签权限。前端展示标签树，勾选后调用batchAddLabel接口保存。此接口为新增接口，标签保存逻辑复用现有服务。

**5.3.5 订舱详情页显示标签**

修改`MarineOrderController.findShippingSpaceMarineOrderById()`方法（第407行），调用`LabelOrderService.findSelectedLabel()`方法获取订单标签，判断用户有查看标签权限后才返回标签数据。前端在订舱详情页显示标签，支持点击编辑按钮打开编辑标签弹窗。此修改会影响详情页的数据展示。

**5.3.6 标签数据同步**

订舱管理和海运订单管理都从`r_label_order`表和`m_label_info`表获取标签数据，数据天然同步，无需额外处理。两个模块使用相同的标签服务和数据表，保证数据一致性。

**5.3.7 批量删除标签功能**

新增`ShippingSpaceController.batchDeleteLabel()`方法（需新增接口），根据标签ID查询订单ID，再删除`r_label_order`表中的标签关系，保存前判断用户是否有编辑标签权限。前端先选择标签，查询出有该标签的订单，再勾选需要删除标签的订单，调用batchDeleteLabel接口。此接口为新增接口，标签删除逻辑复用现有服务。

**5.3.8-5.3.9 权限校验逻辑**

在`ShippingSpaceController.batchAddLabel()`方法（新增）、`batchDeleteLabel()`方法（新增）以及`MarineOrderController.findShippingSpaceMarineOrderById()`方法（第407行）中增加权限校验，使用Shiro的`@RequiresPermissions`注解进行权限控制。具体权限标识如下：
- 批量添加标签：`bookingCabin:label:batchAdd`
- 批量删除标签：`bookingCabin:label:batchDelete`
- 编辑标签：`bookingCabin:label:edit`
- 查看标签：`bookingCabin:label:view`

权限校验在接口层面直接拦截，若用户无对应权限则返回403 Forbidden错误。此修改会影响标签相关功能的权限控制。

#### 5.4 其他注意事项
- 标签从标签管理模块获取（`m_label_info`表），标签关系保存在`r_label_order`表
- 权限控制使用 Shiro 框架，涉及表：t_user（用户表）、t_role（角色表）、t_menu（菜单/权限表）、t_user_role（用户角色关联表）、t_role_menu（角色菜单关联表）。后端业务接口通过 `@RequiresPermissions` 注解进行权限校验，前端通过 `/api/getPermissions` 接口获取权限列表，根据权限标识控制按钮显示（仅用于用户体验，隐藏无权限按钮，真正的权限校验必须在后端进行，防止前端篡改）
- 删除标签时需考虑级联删除，避免产生孤儿数据
- 前端标签树展示需处理层级关系和父子联动

---

### 六、订舱结果tab支持当前页编辑海运前信息

#### 6.1 模块总结
在订舱结果tab列表增加"编辑"按钮，支持当前页面打开"订单海运前明细编辑"抽屉，编辑海运前信息，无需跳转到订舱详情页。

#### 6.2 需求点拆解

| 序号 | 场景 | 粒度 | 需求点 | 其他说明 |
|------|------|------|--------|----------|
| 6.2.1 | 订舱结果列表操作列 | 页面展示 | 订舱结果列表操作列增加编辑按钮并进行状态控制 | 根据权限和订单状态决定显示、置灰及置灰原因，更多按钮根据订单状态置灰 |
| 6.2.2 | 点击编辑按钮时 | 点击操作 | 打开编辑抽屉 | 当前页面打开"订单海运前明细编辑"抽屉 |
| 6.2.3 | 打开抽屉时 | 接口调用 | 查询海运前明细数据 | 调用接口获取订单海运前明细信息 |
| 6.2.4 | 点击保存按钮时 | 点击操作 | 保存海运前明细数据并进行权限和状态校验 | 调用保存接口保存海运前明细，校验权限和状态 |

#### 6.3 需求点实现方案

**6.3.1 订舱结果列表操作列按钮和状态控制**

前端实现，在订舱结果列表操作列增加"编辑"按钮，"更多"按钮聚合其他操作。修改`ShippingSpaceController.queryFinishedOrder()`方法（第66行），返回canEdit字段标识用户是否有编辑权限，返回editDisabledReason字段标识置灰原因，返回更多按钮的置灰状态。前端根据后端返回的状态决定按钮的显示和置灰。此修改为纯前端修改，需配合后端接口改动。

**6.3.2 编辑抽屉和查询接口**

前端实现，点击编辑按钮后，当前页面打开"订单海运前明细编辑"抽屉。新增`MarineOrderController.getPreShippingInfo()`方法（需新增接口），专门用于获取海运前明细数据，返回所有海运前相关的字段数据。查询接口需要返回所有海运前相关的字段数据。此接口为新增接口，避免复用findShippingSpaceMarineOrderById方法导致的性能问题。

**6.3.3 保存海运前明细数据**

保存海运前明细数据接口已存在，直接调用`MarineOrderController.shippingOrderModify()`方法（第446行）保存。在保存方法中增加权限校验和状态校验，权限校验使用Shiro判断用户是否有编辑权限，状态校验判断订单是否处于可编辑状态。校验不通过则返回错误信息。此接口为复用现有接口，保存逻辑复用现有Service方法。

#### 6.4 其他注意事项
- 保存接口要注意权限校验，防止越权操作
- 抽屉页的校验逻辑需与订舱详情页保存校验一致，确保数据一致性
- 打开抽屉时需再次校验订单状态，防止用户在打开抽屉过程中订单状态发生变化
- 保存成功后需刷新列表数据或提示用户刷新列表
- 保存时，需要验证权限和订单状态
- 前端抽屉需处理表单验证和错误提示

---

### 七、订舱管理支持批量取消订舱功能

#### 7.1 模块总结
支持在待订舱/订舱中、订舱结果、异常待处理tab批量取消订舱，包括直接取消（无需发送邮件）和批量发送取消邮件两种方式，并调整权限菜单。

#### 7.2 需求点拆解

| 序号 | 场景 | 粒度 | 需求点 | 其他说明 |
|------|------|------|--------|----------|
| 7.2.1 | 发取消邮件失败时 | 数据处理 | 调整订舱日志记录顺序 | 先记录发取消邮件的动作，再记录订单异常 |
| 7.2.2 | 待订舱/订舱中列表 | 页面展示 | 待订舱/订舱中增加批量取消按钮 | 增加"批量取消订舱"下拉按钮，显示"直接取消"、"批量发取消邮件"选项 |
| 7.2.3 | 待订舱/订舱中列表 | 页面展示 | 批量发订舱邮件按钮更名 | 原"批量发邮件"按钮更名为"批量发订舱邮件" |
| 7.2.4 | 批量操作时 | 数据处理 | 批量操作权限控制 | 判断用户是否有相应功能权限 |
| 7.2.5 | 点击直接取消时 | 点击操作 | 待订舱/订舱中、订舱结果直接取消 | 校验订单状态，批量直接取消订单 |
| 7.2.6 | 点击批量发取消邮件时 | 点击操作 | 待订舱/订舱中、订舱结果批量发取消邮件 | 校验订单，批量发送取消邮件 |
| 7.2.7 | 订舱结果列表 | 页面展示 | 订舱结果增加批量取消按钮 | 增加"批量取消订舱"下拉按钮，显示"直接取消"、"批量发取消邮件"选项 |
| 7.2.8 | 点击批量取消时 | 点击操作 | 异常待处理列表批量取消 | 校验异常原因，批量取消订单 |
| 7.2.9 | 权限管理时 | 页面展示 | 权限菜单增加批量取消子菜单 | 订舱管理下各tab下增加子菜单：批量取消订舱（直接取消、发取消邮件） |

#### 7.3 需求点实现方案

**7.3.1 调整订舱日志记录顺序**

修改`ShippingSpaceInfoServiceImpl.sendCancelMail()`方法（第1113行），在发送取消邮件失败时，先调用订舱日志记录方法记录"发取消邮件"动作，再记录"订单异常"。原逻辑可能是先记录异常再记录操作，现需调整顺序。此修改影响取消订舱邮件发送失败的日志记录逻辑。

**7.3.2-7.3.3 前端按钮添加和更名**

前端实现，在待订舱/订舱中列表上方增加"批量取消订舱"下拉按钮，下拉选项为"直接取消"、"批量发取消邮件"。将原"批量发邮件"按钮更名为"批量发订舱邮件"。此修改为纯前端修改，不涉及后端逻辑。

**7.3.4 批量操作权限控制**

在批量操作接口中使用 Shiro 的 `@RequiresPermissions` 注解进行权限校验。具体权限标识如下：
- 批量直接取消：`bookingCabin:batchCancel:direct`
- 批量发送取消邮件：`bookingCabin:batchCancel:sendMail`
- 批量忽略异常：`bookingCabin:batchIgnore:abnormal`

权限校验在接口层面直接拦截，若用户无对应权限则返回 403 Forbidden 错误。前端通过 `/api/getPermissions` 接口获取权限列表，根据权限标识控制按钮显示（仅用于用户体验，隐藏无权限按钮，真正的权限校验必须在后端进行，防止前端篡改）。

**7.3.5-7.3.6 待订舱/订舱中、订舱结果批量取消**

新增`ShippingSpaceController.batchDirectCancel()`方法（需新增接口），接收orderIds和tabType参数，校验订单状态（订舱中、审核状态为空、无订舱异常、无取消邮件发送中），批量取消订单。新增`ShippingSpaceController.batchSendCancelMail()`方法（需新增接口），接收orderIds和邮件参数，校验订单状态、来源系统、国别、货代一致性，批量发送取消邮件。

待订舱/订舱中tab的收件人取值逻辑：
**第二版变更说明**：
- 批量取消订舱时，收件人取值逻辑需要调整
- 取所有已选订单的订舱邮件收件人邮箱并集（原逻辑为：自动带出原发订舱邮件的收件人邮箱 + 该货运代理配置的收件邮箱中与原发订舱邮件收件人不重合的邮箱）
- 需要查询所有已选订单的订舱邮件记录（t_shipping_space_mail表），获取所有收件人邮箱
- 将所有收件人邮箱取并集后，再加上该货运代理配置的收件邮箱中与订舱邮件收件人不重合的邮箱
- 若订单未发送过订舱邮件，则只取该货运代理对应国别的配置邮箱

**第二版变更说明 - 待订舱/订舱中收件人取值逻辑实现方案**：

修改`ShippingSpaceController.batchSendCancelMail()`方法（新增），在获取收件人邮箱时，增加以下处理逻辑：

1. **查询所有已选订单的订舱邮件记录**：
   - 从订舱邮件表（t_shipping_space_mail）查询所有已选订单的订舱邮件记录
   - 查询条件：shipping_space_id IN (orderIds) AND mail_type = '订舱邮件'（需确认mail_type的具体值）
   - 获取所有收件人邮箱（receiver字段）

2. **获取收件人邮箱并集**：
   - 将所有订单的收件人邮箱合并，去重后得到收件人邮箱并集
   - 使用Set集合去重，确保邮箱不重复

3. **获取货运代理配置邮箱**：
   - 从货运代理配置表（m_agent_config）查询当前货运代理对应国别的配置邮箱
   - 查询条件：agent_abbr = 当前货运代理简称 AND country = 订单国别
   - 获取配置邮箱列表（config_email字段，需确认具体字段名）

4. **合并收件人邮箱**：
   - 将货运代理配置邮箱与订舱邮件收件人邮箱并集进行对比
   - 保留货运代理配置邮箱中与订舱邮件收件人不重合的邮箱
   - 最终收件人 = 订舱邮件收件人邮箱并集 + 货运代理配置邮箱中不重合的邮箱

5. **处理未发送订舱邮件的订单**：
   - 若订单未发送过订舱邮件（t_shipping_space_mail表中无记录），则只取货运代理配置邮箱
   - 需要判断每个订单是否发送过订舱邮件

6. **返回收件人邮箱列表**：
   - 将最终收件人邮箱列表返回给前端
   - 前端在邮件编辑弹窗中展示收件人邮箱

**注意事项**：
- 需要确认订舱邮件表（t_shipping_space_mail）的字段结构
- 需要确认货运代理配置表（m_agent_config）的字段结构
- 需要确认mail_type的枚举值（订舱邮件、取消邮件等）
- 需要处理邮箱格式校验（去除前后空格、校验邮箱格式）
- 需要处理收件人邮箱为空的情况（提示用户配置货运代理邮箱）

订舱结果tab的收件人取值逻辑：
**第二版变更说明**：
- 批量取消订舱时，收件人取值逻辑需要根据不同场景处理：
1. 若所选订单皆通过线上订舱邮件订舱后，且在录入SO后未变更货运代理简称的，自动带出所有已选订单原发订舱邮件的收件人邮箱取并集 + 该货运代理配置的收件邮箱中与原发订舱邮件收件人不重合的邮箱
2. 若通过线上订舱邮件订舱后，但在录入SO后存在订单的货运代理简称已发生变更，收件人为：所有未变更货运代理的订单原发订舱邮件收件人邮箱并集 + 当前代理对应订单国别的邮箱中不重合的邮箱
3. 若所选订单皆未发送订舱邮件，直接通过录入SO实现订舱状态流转的，自动获取当前货运代理对应国别的配置邮箱
4. 若所选订单，存在部分发订舱邮件，部分未发订舱邮件的，收件人为：已发订舱邮件订单的订舱邮件收件人并集 + 当前代理对应订单国别的邮箱中不重合的邮箱
   - 若发订舱邮件的订单中存在代理变更的，收件人为：所有未变更货运代理的订单原发订舱邮件收件人邮箱并集 + 当前代理对应订单国别的邮箱中不重合的邮箱
- 需要查询所有已选订单的订舱邮件记录（t_shipping_space_mail表），判断是否发送过订舱邮件
- 需要从订舱邮件的`shipping_detail_info`字段（JSON格式）中解析出原始货运代理ID，对比当前货运代理ID判断是否变更过货运代理
- 需要从合作代理邮箱表（m_cooperation_agent_email）查询当前货运代理对应国别的配置邮箱

**第二版变更说明 - 订舱结果收件人取值逻辑实现方案**：

修改`ShippingSpaceController.batchSendCancelMail()`方法（新增），在获取收件人邮箱时，增加以下处理逻辑：

1. **查询所有已选订单的订舱邮件记录**：
   - 从订舱邮件表（t_shipping_space_mail）查询所有已选订单的订舱邮件记录
   - 查询条件：shipping_space_id IN (orderIds) AND mail_type = '订舱邮件'
   - 获取所有收件人邮箱（receiver字段）和货运代理简称（agent_abbr字段）

2. **判断订单是否变更过货运代理**：
   - 从订舱邮件表（t_shipping_space_mail）查询所有已选订单的订舱邮件记录
   - 查询条件：shipping_space_id IN (orderIds) AND mail_type = '订舱邮件'
   - 从订舱邮件的`shipping_detail_info`字段（JSON格式）中解析出原始货运代理ID（agentId）
   - 对比当前货运代理ID和原始货运代理ID，判断是否变更过货运代理
   - 若当前货运代理ID与原始货运代理ID不同，则认为该订单变更过货运代理

3. **获取货运代理配置邮箱**：
   - 从合作代理邮箱表（m_cooperation_agent_email）查询当前货运代理对应国别的配置邮箱
   - 查询条件：通过货运代理ID查询对应的合作代理行ID（cooperation_agent_line_id），再根据合作代理行ID和国别查询邮箱
   - 获取配置邮箱列表（email字段），过滤status=true的有效邮箱

4. **分类处理订单**：
   - 将订单分为以下几类：
     - 发送过订舱邮件且未变更货运代理的订单
     - 发送过订舱邮件且变更过货运代理的订单
     - 未发送过订舱邮件的订单

5. **计算收件人邮箱**：
   - **场景1：所有订单都发送过订舱邮件且未变更货运代理**：
     - 获取所有订单的订舱邮件收件人邮箱，取并集
     - 加上货运代理配置邮箱中与订舱邮件收件人不重合的邮箱
   - **场景2：部分订单变更过货运代理**：
     - 获取未变更货运代理的订单的订舱邮件收件人邮箱，取并集
     - 加上当前货运代理配置邮箱中与订舱邮件收件人不重合的邮箱
   - **场景3：所有订单都未发送过订舱邮件**：
     - 只取当前货运代理对应国别的配置邮箱
   - **场景4：部分订单发送过订舱邮件，部分未发送**：
     - 获取发送过订舱邮件的订单的收件人邮箱，取并集
     - 加上当前货运代理配置邮箱中与订舱邮件收件人不重合的邮箱
     - 若发送过订舱邮件的订单中存在代理变更的，则只取未变更货运代理的订单的收件人邮箱

6. **返回收件人邮箱列表**：
   - 将最终收件人邮箱列表返回给前端
   - 前端在邮件编辑弹窗中展示收件人邮箱

**注意事项**：（错误，根据技术方案调整）
- 需要确认订舱日志表（t_shipping_space_operation_log）的字段结构
- 需要确认operation_type的枚举值（变更货运代理、录入SO等）
- 需要处理货运代理变更的判断逻辑（对比当前货运代理和变更前的货运代理）
- 需要处理收件人邮箱为空的情况（提示用户配置货运代理邮箱）
- 需要处理并发情况，防止在获取收件人邮箱时订单状态发生变化

这两个接口为新增接口，复用现有的取消和邮件发送逻辑。接口需添加 `@RequiresPermissions` 注解：
- `batchDirectCancel()`：`@RequiresPermissions("bookingCabin:batchCancel:direct")`
- `batchSendCancelMail()`：`@RequiresPermissions("bookingCabin:batchCancel:sendMail")`

**7.3.7 订舱结果批量取消**

前端实现，在订舱结果列表上方增加"批量取消订舱"下拉按钮。订舱结果调用`ShippingSpaceController.batchDirectCancel()`方法（新增）和`batchSendCancelMail()`方法（新增），tabType传"finished"。后端接口逻辑与待订舱/订舱中不同，校验逻辑包括：订舱状态是否为已订舱、进行中的订单实际进港日是否有值、订单是否处于审核状态中、订单是否处于订舱异常、订单是否有取消订舱的邮件正在发送中。收件人取值逻辑与待订舱/订舱中不同，需根据是否发送订舱邮件、是否变更货运代理简称等情况确定。此修改需配合前端按钮添加。

**7.3.8 异常待处理列表批量取消**

异常待处理列表批量取消功能已存在，调用`ShippingSpaceController.atchCancelShippingSpace()`方法（已存在接口），无需新增。该方法接收shippingSpaceIds参数，校验异常原因（仅邮件发送失败不支持取消），批量取消订单。接口已添加 `@RequiresPermissions("bookingCabin:batchCancel:direct")` 注解。

**7.3.9 权限菜单配置**

在订舱管理 > 待订舱/订舱中/订舱结果/异常待处理下增加子菜单：批量取消订舱（直接取消、发取消邮件），配置相应的权限标识。权限标识需要在 t_menu 表中配置，类型为按钮（type = 1）。具体权限标识如下：
- 批量直接取消：`bookingCabin:batchCancel:direct`
- 批量发送取消邮件：`bookingCabin:batchCancel:sendMail`
- 批量忽略异常：`bookingCabin:batchIgnore:abnormal`

通过角色-菜单关联表（t_role_menu）将权限分配给对应角色。此修改影响权限管理功能。

#### 7.4 其他注意事项
- 批量操作需支持部分成功、部分失败的情况，返回详细的失败原因和失败订单列表
- 并发校验需考虑订单状态、审核状态、异常状态的变更，防止数据不一致
- 发送邮件失败时需记录异常到订舱异常表，订单状态保持不变
- 批量取消邮件需检查收件人邮箱是否配置，未配置则提示错误
- 筛选可取消订单功能需根据不同tab的条件筛选，减少用户误操作
- 取消操作需考虑关联数据的处理，如集装箱、费用等

---

### 八、订舱异常待处理Tab操作说明

#### 8.1 模块总结
优化异常待处理tab的操作按钮显示逻辑，根据不同异常类型显示不同操作按钮；增加邮件发送失败的气泡提示；支持批量忽略异常和重发邮件功能。

#### 8.2 需求点拆解

| 序号 | 场景 | 粒度 | 需求点 | 其他说明 |
|------|------|------|--------|----------|
| 8.2.1 | 鼠标悬移至标签时 | 页面展示 | 异常气泡提示 | 根据异常类型显示不同气泡提示：单订舱邮件失败、批量订舱邮件失败、单取消订舱邮件失败、批量取消订舱邮件失败 |
| 8.2.2 | 异常类型不同时 | 页面展示 | 操作按钮列表 | 根据异常类型显示不同操作按钮：仅订舱邮件失败显示记录、重发、忽略；仅取消订舱邮件失败显示记录、重发；邮件失败+其他异常显示记录、重发；含订单已取消/重新申请显示记录、取消；其他异常显示记录、取消、忽略 |
| 8.2.3 | 重发成功后 | 数据处理 | 重发成功后订舱状态处理 | 批量订舱邮件重发成功后，批量发送的所有订单皆自动取消异常，订舱状态保持不变；批量取消订舱邮件重发成功后，批量发送的所有订单皆自动取消异常，订舱状态变更为待订舱 |
| 8.2.4 | 批量邮件失败重发时 | 页面展示 | 重发功能提示文案调整 | 根据订舱/取消订舱邮件失败显示不同提示文案 |
| 8.2.5 | 重发取消订舱邮件失败时 | 点击操作 | 重发增加直接取消选项 | 增加"直接取消"文字按钮，点击可跳过邮件发送直接取消订单 |
| 8.2.6 | 点击批量忽略按钮时 | 点击操作 | 批量忽略异常功能 | 校验异常原因，批量忽略异常，需先查询可以批量忽略的订单 |
| 8.2.7 | 忽略异常需补录目的港时 | 点击操作 | 批量忽略目的港补录 | 若订单因更改分区导致目的港清空，需补录目的港 |

#### 8.3 需求点实现方案

**8.3.1 异常气泡提示**

修改`ShippingSpaceController.queryAbnormalOrder()`方法（第73行），根据异常类型生成不同的气泡提示文本。单订舱邮件失败返回"订舱邮件发送失败"；批量订舱邮件失败从批量发送记录中获取订单数量n，返回"批量发送订舱邮件失败，订单数:n条，任一订单重发成功后，批量发送的所有订单皆自动取消异常"；单取消订舱邮件失败返回"取消订舱邮件发送失败"；批量取消订舱邮件失败返回"批量发送取消订舱邮件失败，订单数:n条，任一订单重发成功后，批量发送的所有订单皆自动取消异常"。前端根据返回的mailFailBubbleText字段显示气泡提示。

**8.3.2 操作按钮列表**

修改`ShippingSpaceController.queryAbnormalOrder()`方法（第73行），根据异常类型返回不同的操作按钮列表。仅订舱邮件失败返回buttons=["record", "resend", "ignore"]；仅取消订舱邮件失败返回buttons=["record", "resend"]；邮件失败+其他异常返回buttons=["record", "resend"]；异常原因中包含订单已取消或重新申请返回buttons=["record", "cancel"]；其他异常返回buttons=["record", "cancel", "ignore"]。前端根据返回的buttons数组显示对应的操作按钮。

**8.3.3 重发功能提示文案调整**

修改`ShippingSpaceController.getResendMailInfo()`方法（第236行）的重发邮件接口，该接口已使用 `@RequiresPermissions("booking:handleException:resend")` 注解进行权限校验。若为批量订舱邮件失败，提示"以下订单批量发订舱邮件失败，若重发邮件，则下列订单将一起批量重发 重发邮件成功后，将一起取消异常提示"；若为批量取消订舱邮件失败，提示"以下订单批量发取消订舱邮件失败，若重发邮件，则下列订单将一起批量重发 重发邮件成功后，将一起取消异常提示"。前端根据异常类型显示不同的提示文案。

**第二版变更说明 - 重发成功后处理逻辑**：
- 若失败的是订舱邮件，重发成功后，订舱状态流转为"订舱中"，同时移出异常列表，异常图标消失（原逻辑，无需修改）
- 若失败的是取消订舱邮件，重发成功后的处理逻辑需要根据原订舱状态和叠加异常情况分别处理：
  1. 若无其他异常，且原订舱状态为"订舱中"，重发成功后订舱状态流转为"待订舱"，同时移出异常列表，异常图标消失
  2. 若无其他异常，且原订舱状态为"已订舱"，重发成功后订舱状态流转为"待订舱"，同时移出异常列表，异常图标消失，订单状态变更为【待确认发船】，同时清空海运前相关字段信息，订单信息同步上游系统，超重标签，集装箱免用时间，已匹配报价的需做相应处理
  3. 若叠加其他异常，且异常原因为【订单更改分区】【订单信息修改】的，按照上述原订舱状态做相应处理即可
  4. 若叠加其他异常，且异常原因为【订单已取消】的，则订舱状态变更为【已取消】，订单移出异常待处理列表，进入"订舱结果"列表，异常图标消失
  5. 若叠加其他异常，且异常原因为【订单重新申请】的，原订舱状态作废

**第二版变更说明 - 重发成功后处理逻辑实现方案**：

修改`ShippingSpaceInfoServiceImpl.resendCancelMail()`方法，在重发取消订舱邮件成功后，增加以下处理逻辑：

1. **查询原订舱状态和异常信息**：
   - 从订舱异常表（t_shipping_space_exception）查询订单的所有异常记录
   - 从订舱日志表（t_shipping_space_operation_log）查询取消订舱前的订舱状态（在取消订舱时记录）
   - 判断是否存在其他异常（除了邮件发送失败之外的异常）

2. **处理无其他异常的情况**：
   - 若原订舱状态为"订舱中"（shipping_space_status=2）：
     - 更新订舱状态为"待订舱"（shipping_space_status=1）
     - 删除异常记录（t_shipping_space_exception）
     - 订单状态保持不变
   - 若原订舱状态为"已订舱"（shipping_space_status=3）：
     - 更新订舱状态为"待订舱"（shipping_space_status=1）
     - 更新订单状态为"待确认发船"
     - 清空海运前相关字段：
       - 清空船名航次（transport_vessel_name）
       - 清空集装箱号（container）
       - 清空实际进港日（enter_port_date）
       - 清空实际离港日（actual_departure_time）
       - 清空ISF相关字段（isf_agent_id、isf_flag）
       - 清空清关代理简称（customs_clear_agent_id）
       - 清空是否有火车运输（train_flag）
     - 删除异常记录（t_shipping_space_exception）
     - 同步订单信息到上游系统（调用订单同步接口）
     - 处理超重标签（删除订单的超重标签记录）
     - 处理集装箱免用时间（重置或删除集装箱免用时间记录）
     - 处理已匹配报价（取消或重置已匹配的报价记录）

3. **处理叠加其他异常的情况**：
   - 若叠加异常原因为【订单更改分区】或【订单信息修改】：
     - 按照原订舱状态做相应处理（同上）
   - 若叠加异常原因为【订单已取消】：
     - 更新订舱状态为"已取消"
     - 删除异常记录（t_shipping_space_exception）
     - 订单移出异常待处理列表，进入"订舱结果"列表
   - 若叠加异常原因为【订单重新申请】：
     - 原订舱状态作废，无需更新
     - 删除异常记录（t_shipping_space_exception）
     - 订单移出异常待处理列表

4. **记录操作日志**：
   - 在重发取消订舱邮件成功后，记录操作日志到订舱日志表（t_shipping_space_operation_log）
   - 记录原订舱状态、新订舱状态、清空的字段信息等

5. **事务处理**：
   - 所有更新操作需在一个事务中完成，确保数据一致性
   - 若任一步骤失败，需回滚所有操作

**注意事项**：
- 需要在取消订舱邮件发送失败时，记录原订舱状态到日志表或异常表中
- 需要确认订单状态、订舱状态的枚举值
- 需要确认上游系统同步接口的调用方式和参数
- 需要确认超重标签、集装箱免用时间、已匹配报价的处理逻辑
- 需要处理并发情况，防止重发成功后订单状态被其他操作修改

**8.3.4 重发增加直接取消选项**

前端实现，在重发取消订舱邮件失败的弹窗中增加"直接取消"文字按钮。点击"直接取消"后，调用`ShippingSpaceController.batchDirectCancel()`方法（新增）跳过邮件发送直接取消订单。后端需要支持在重发流程中直接取消的逻辑。此修改需要前后端配合实现。

**8.3.5-8.3.7 批量忽略异常和目的港补录**（错误：不用接收tabType参数，交互需产品确认）

新增`ShippingSpaceController.filterCanIgnoreOrders()`方法（需新增接口），接收tabType参数，查询可以批量忽略的订单，过滤掉处于审核状态中、异常原因仅有邮件发送失败的订舱邮件等不支持忽略的订单。新增`ShippingSpaceController.batchIgnoreAbnormal()`方法（需新增接口），接收shippingSpaceIds参数，校验异常原因（仅邮件发送失败的订舱邮件不支持忽略），批量更新异常记录为已处理。新增`ShippingSpaceController.supplementDestinationPort()`方法（需新增接口），接收shippingSpaceIds和destinationPort参数，批量补录目的港，校验目的港有效性（状态有效、与订单分区匹配）。这三个接口为新增接口，处理批量忽略和目的港补录逻辑。接口需添加 `@RequiresPermissions` 注解：
- `filterCanIgnoreOrders()`：`@RequiresPermissions("bookingCabin:batchIgnore:abnormal")`
- `batchIgnoreAbnormal()`：`@RequiresPermissions("bookingCabin:batchIgnore:abnormal")`
- `supplementDestinationPort()`：`@RequiresPermissions("bookingCabin:batchIgnore:abnormal")`

#### 8.4 其他注意事项
- 批量忽略异常时需校验订单是否已处理、是否并发其他异常、是否在审核状态中
- 目的港补录需校验目的港有效性和与订单分区匹配
- 批量操作需支持部分成功、部分失败的情况，返回详细的失败原因
- 气泡提示中的n需从批量发送记录中准确获取
- 重发失败时需检查批量发送记录中的订单列表，确保重发时包含所有订单
- 忽略操作需谨慎，确保异常不会影响后续业务流程

---

### 九、订舱管理列表字段及查询字段调整

#### 9.1 模块总结
在待订舱/订舱中、订舱结果列表增加新的显示字段（订单标签、集装箱号、截单时间、货重等）和查询字段（订单标签、集装箱号、提单号、截单时间、采购单号等）。

#### 9.2 需求点拆解

| 序号 | 场景 | 粒度 | 需求点 | 其他说明 |
|------|------|------|--------|----------|
| 9.2.1 | 待订舱/订舱中列表 | 页面展示 | 待订舱/订舱中列表增加订单标签显示 | 放在"物流备注"字段前，多个标签英文逗号分隔 |
| 9.2.2 | 待订舱/订舱中查询区 | 页面展示 | 待订舱/订舱中查询区增加订单标签查询 | 支持多选，选项为标签管理中所有标签 |
| 9.2.3 | 订舱结果列表 | 页面展示 | 订舱结果列表增加集装箱号显示 | 放在"增值服务"字段前，不固定 |
| 9.2.4 | 订舱结果列表 | 页面展示 | 订舱结果列表增加截单时间显示 | 放在"ETA"字段后 |
| 9.2.5 | 订舱结果列表 | 页面展示 | 订舱结果列表增加货重显示 | 放在"货代放行"字段后 |
| 9.2.6 | 订舱结果列表 | 页面展示 | 订舱结果列表增加订单标签显示 | 放在"货重"字段后，多个标签英文逗号分隔 |
| 9.2.7 | 订舱结果查询区 | 页面展示 | 订舱结果查询区增加集装箱号查询 | 放在"入库单号"字段后，输入框，精确查询，支持批量查询 |
| 9.2.8 | 订舱结果查询区 | 页面展示 | 订舱结果查询区增加提单号查询 | 放在"船公司"字段后，输入框，模糊查询，支持批量查询 |
| 9.2.9 | 订舱结果查询区 | 页面展示 | 订舱结果查询区增加截单时间查询 | 放在"ETA"字段后，日期区间选择 |
| 9.2.10 | 订舱结果查询区 | 页面展示 | 订舱结果查询区增加采购单号查询 | 放在"客户号"字段后，输入框，模糊查询 |
| 9.2.11 | 订舱结果查询区 | 页面展示 | 订舱结果查询区增加订单标签查询 | 放在最后，支持多选，选项为标签管理中所有标签 |

#### 9.3 需求点实现方案

**9.3.1-9.3.2 待订舱/订舱中列表标签显示和查询**

修改`ShippingSpaceController.queryUnfinishedOrder()`方法（第59行），调用LabelOrderService.findByOrderIds()获取订单标签，拼接成逗号分隔的字符串返回。在查询条件中增加labelIds参数，根据标签ID过滤订单。前端在列表中显示标签文本，在查询区提供多选标签过滤。此修改会影响列表的显示和查询逻辑。（错误：返回多个标签，让前端拼接）

**9.3.3-9.3.6 订舱结果列表新增字段显示**

修改`ShippingSpaceController.queryFinishedOrder()`方法（第66行），返回container（集装箱号）、cutoffDate（截单时间）、weight（货重）字段。调用LabelOrderService.findByOrderIds()获取订单标签，拼接成逗号分隔的字符串返回。字段位置按需求要求放置在对应位置。此修改会增加列表返回的数据量。

**9.3.7-9.3.11 订舱结果查询区新增查询条件**

修改`ShippingSpaceController.queryFinishedOrder()`方法（第66行），在查询条件中增加container（集装箱号，精确查询，支持批量）、mbl（提单号，模糊查询，支持批量）（错误：产品确定）、cutoffDateStart和cutoffDateEnd（截单时间，日期区间查询）、purchaseOrderNumber（采购单号，模糊查询）、labelIds（订单标签，多选查询）参数。查询逻辑需要处理批量查询的IN条件。此修改会增加查询条件的复杂度。

#### 9.4 其他注意事项
- 订单标签查询逻辑需与海运订单管理保持一致
- 集装箱号、提单号支持批量查询，需处理英文逗号分隔和空格
- 列表查询需考虑性能优化，增加必要的数据库索引
- 字段显示需处理NULL值和特殊字符
- 批量查询需处理SQL注入风险，使用参数化查询

---

### 十、订舱模块导入功能调整

#### 10.1 模块总结
在导入预定舱信息、导入SO、订舱结果导入中增加新字段（订单标签、备注字段、ISF相关字段、是否有火车运输等），并支持订单标签和备注字段的追加或覆盖导入。

#### 10.2 需求点拆解

| 序号 | 场景 | 粒度 | 需求点 | 其他说明 |
|------|------|------|--------|----------|
| 10.2.1 | 导入预定舱信息时 | 页面展示 | 导入预定舱信息增加订单标签 | Excel模版增加"订单标签"字段 |
| 10.2.2 | 导入预定舱信息时 | 页面展示 | 导入预定舱信息增加起运港备注 | Excel模版增加"起运港备注"字段 |
| 10.2.3 | 导入预定舱信息时 | 页面展示 | 导入预定舱信息增加清关备注 | Excel模版增加"清关备注"字段 |
| 10.2.4 | 导入预定舱信息时 | 页面展示 | 导入预定舱信息增加目的港备注 | Excel模版增加"目的港备注"字段 |
| 10.2.5 | 选择导入方式时 | 点击操作 | 导入预定舱信息支持追加/覆盖 | 订单标签、备注字段支持追加或覆盖导入 |
| 10.2.6 | 导入SO时 | 页面展示 | 导入SO增加是否有火车运输 | Excel模版增加"是否有火车运输"字段 |
| 10.2.7 | 导入SO时 | 页面展示 | 导入SO增加订单标签 | Excel模版增加"订单标签"字段 |
| 10.2.8 | 导入SO时 | 页面展示 | 导入SO增加备注字段 | Excel模版增加"起运港备注"、"清关备注"、"目的港备注"字段 |
| 10.2.9 | 选择导入方式时 | 点击操作 | 导入SO支持追加/覆盖 | 订单标签、备注字段支持追加或覆盖导入 |
| 10.2.10 | 订舱结果导入时 | 页面展示 | 订舱结果导入增加ISF代理简称 | Excel模版增加"ISF代理简称"字段，放在"实际进港日"后 |
| 10.2.11 | 订舱结果导入时 | 页面展示 | 订舱结果导入增加ISF | Excel模版增加"ISF"字段，放在"ISF代理简称"后 |
| 10.2.12 | 订舱结果导入时 | 页面展示 | 订舱结果导入增加清关代理简称 | Excel模版增加"清关代理简称"字段，放在"ISF"后 |
| 10.2.13 | 订舱结果导入时 | 页面展示 | 订舱结果导入增加是否有火车运输 | Excel模版增加"是否有火车运输"字段，放在"目的港"后 |
| 10.2.14 | 订舱结果导入时 | 页面展示 | 订舱结果导入增加订单标签和备注 | Excel模版增加"订单标签"、"起运港备注"、"清关备注"、"目的港备注"字段，放在"货代放行"后 |
| 10.2.15 | 选择导入方式时 | 点击操作 | 订舱结果导入支持追加/覆盖 | 订单标签、备注字段支持追加或覆盖导入 |

#### 10.3 需求点实现方案

**10.3.1-10.3.4 导入预定舱信息增加字段**

修改导入预定舱信息的Excel模版，增加"订单标签"、"起运港备注"、"清关备注"、"目的港备注"列。修改`ShippingSpaceController.importBookingCabinInformation()`方法（第350行），解析Excel中的新字段，调用标签保存逻辑（订单标签）和备注保存逻辑（备注字段）。模版中需添加字段说明，如订单标签多个用英文逗号分隔，备注字段最大400字符。

**10.3.5 导入预定舱信息支持追加/覆盖**

前端在导入弹窗中增加导入方式选择（追加/覆盖），支持订单标签和备注字段设置。修改`ShippingSpaceController.importBookingCabinInformation()`方法（第350行），根据导入方式参数，决定是追加还是覆盖标签和备注字段。追加模式下调用LabelOrderService.insetOrderLabelConn()时batchFlag=true，覆盖模式下先删除原有标签关系再新增。

**10.3.6-10.3.8 导入SO增加字段**（错误:技术方案与2.3.3重复）

修改导入SO的Excel模版，增加"是否有火车运输"、"订单标签"、"起运港备注"、"清关备注"、"目的港备注"列。修改`ShippingSpaceController.importSoInfo()`方法（第338行），解析Excel中的新字段，调用保存逻辑。是否有火车运输需要校验美/加订单必填，欧日订单无需填写。

**10.3.9 导入SO支持追加/覆盖**

前端在导入弹窗中增加导入方式选择（追加/覆盖）。修改`ShippingSpaceController.importSoInfo()`方法（第338行），根据导入方式参数，决定是追加还是覆盖标签和备注字段。处理逻辑与导入预定舱信息相同。

**10.3.10-10.3.14 订舱结果导入增加字段**

修改订舱结果导入的Excel模版，增加"ISF代理简称"、"ISF"、"清关代理简称"、"是否有火车运输"、"订单标签"、"起运港备注"、"清关备注"、"目的港备注"列，按顺序放在对应位置。修改`ShippingSpaceController.importPreShippingSpaceInformation()`方法（第362行），解析Excel中的新字段，调用保存逻辑。ISF相关字段需要校验代理简称是否存在、是否有效、国别是否匹配。

**10.3.15 订舱结果导入支持追加/覆盖**

前端在导入弹窗中增加导入方式选择（追加/覆盖）。修改`ShippingSpaceController.importPreShippingSpaceInformation()`方法（第362行），根据导入方式参数，决定是追加还是覆盖标签和备注字段。处理逻辑与导入预定舱信息相同。

#### 10.4 其他注意事项
- 导入方式设置：追加导入保留原值，覆盖导入清空原值
- 订单标签导入时需与标签管理中的标签名称匹配，若不存在则记录错误
- 备注字段导入时需校验字符数限制（400字符），超出则记录错误。库中数据+新增数据长度不能大于400
- ISF相关字段导入时需校验代理简称是否存在、是否有效、国别是否匹配
- 是否有火车运输字段导入时需校验美/加订单必填，欧日订单无需填写
- OSJ订单导入清关代理简称时，若包含"关税代理"类型，需自动赋值给费用填写页面的关税代理简称
- 导入功能需处理大量数据的性能问题，可考虑分批处理
- excel中重复数据自动去重
- 导入和新增订舱标签，如标签已经存在，不报错，不插入数据
- 导入结果需返回详细的成功/失败信息，便于用户定位问题，错误数据在第一列

---

### 十一、订舱模块其他优化

#### 11.1 模块总结
优化邮件发送中状态下的操作限制，优化待订舱状态下的异常记录逻辑，优化OSJ订单取消订舱流程中的抄送人选择提示，增加批量操作时的"去处理"按钮。

#### 11.2 需求点拆解

| 序号 | 场景 | 粒度 | 需求点 | 其他说明 |
|------|------|------|--------|----------|
| 11.2.1 | 列表展示时 | 页面展示 | 邮件发送中按钮置灰 | 邮件发送中时铅笔编辑、录入SO等按钮置灰，显示置灰原因"邮件发送中，不支持操作" |
| 11.2.2 | 点击确定时 | 点击操作 | 批量操作邮件发送中校验 | 批量填写货运代理、船公司、导入预定舱、导入SO时校验邮件发送中状态 |
| 11.2.3 | 邮件发送中产生异常时 | 数据处理 | 待订舱状态异常记录优化 | 异常不显示在异常待处理列表，邮件发送成功后展示，邮件发送失败时忽略 |
| 11.2.4 | 发取消邮件时 | 页面展示 | OSJ订单取消订舱抄送人提示 | 更改货运代理或直接录入SO异常后取消订舱时，显示抄送人选择提示 |
| 11.2.5 | 批量操作有异常提示时 | 页面展示 | 批量操作增加去处理按钮 | 弹窗中增加"去处理"文本按钮，跳转到异常待处理列表 |

#### 11.3 需求点实现方案

**11.2.1 邮件发送中按钮置灰**

修改`ShippingSpaceController.queryUnfinishedOrder()`方法（第59行）和`queryFinishedOrder()`方法（第66行），返回isMailSending字段，前端根据状态置灰按钮并显示气泡提示"邮件发送中，不支持操作"。isMailSending字段从shippingSpace表的mailStatus字段获取，mailStatus=0表示发送中。此修改影响列表的展示逻辑。

**11.2.2 批量操作邮件发送中校验**

修改`ShippingSpaceController.batchEdit()`方法（第304行），在保存前校验订单的邮件发送状态，若处于发送中则返回错误"订舱邮件发送中，不支持操作"。修改`ShippingSpaceController.importBookingCabinInformation()`方法（第350行）和`importSoInfo()`方法（第338行），在导入前校验订单的邮件发送状态，若处于发送中则返回相应错误。校验在数据处理前执行，确保用户无法在邮件发送中时进行修改操作。

**11.2.3 待订舱状态异常记录优化**

现有 `ShippingSpaceInfoServiceImpl.createShippingSpaceException()` 行为如下：
1. 若订舱单为待订舱，且异常为【订单已取消】或【订单重新申请】，则将订舱单置为作废并完成异常处理（不进入异常待处理列表）
2. 其他场景：仅当海运单实际进港日为空时创建异常记录（表：`t_shipping_space_abnormal_record`）

**11.2.4 OSJ订单取消订舱抄送人提示**（错误：需产品确认，是否全部osj的都有弹窗）

修改`ShippingSpaceController.sendCancelMail()`方法（第193行）中的取消订舱邮件发送逻辑，检查OSJ订单的货运代理简称是否变更，若变更则在前端显示抄送人选择提示弹窗。检查OSJ订单是否通过线上发订舱邮件，若未发送（直接录入SO）则在前端显示抄送人选择提示弹窗。具体场景包括：
1. OSJ订单通过线上发订舱邮件订舱 > 录入SO > 更改货运代理简称 > 取消订舱时，需有抄送人选择提示弹窗
2. OSJ订单直接录入SO > 出现订舱异常 > 取消订舱时，需有抄送人选择提示弹窗
3. OSJ订单通过线上发订舱邮件订舱 > 录入SO > 更改货运代理简称 > 出现订舱异常 > 取消订舱时，需有抄送人选择提示弹窗

前端根据后端返回的标识决定是否显示抄送人选择弹窗。后端需在取消订舱邮件发送接口中增加判断逻辑，返回是否需要显示抄送人选择弹窗的标识。

**11.2.5 批量操作增加去处理按钮**

修改批量操作接口（如`ShippingSpaceController.batchEdit()`方法等），在批量操作结果中返回异常订单列表（shippingSpaceIds），前端显示"去处理"按钮。点击"去处理"按钮后，跳转到订舱异常待处理列表，并自动筛选出异常订单展示。跳转时将订单ID列表作为参数传递，异常待处理列表根据参数自动筛选。前端需在路由跳转时传递订单ID参数，异常待处理列表页面接收参数后自动调用查询接口筛选订单。此修改需要前后端配合实现。

#### 11.4 其他注意事项
- 邮件发送状态：使用 `SendStatusEnum`（1发送中，2成功，3失败）；列表透出字段为 `isShowMailSending`
- 异常记录优化需考虑邮件发送成功和失败两种情况的处理
- OSJ订单取消订舱需考虑多种场景：线上发订舱邮件、直接录入SO、更改货运代理简称
- 去处理跳转需传递订单ID参数，自动在异常待处理列表中筛选展示
- 校验逻辑需考虑并发情况，防止状态检查后订单状态发生变化

---

### 十二、海运订单管理调整

#### 12.1 模块总结
调整海运订单详情页字段位置和编辑权限，船名航次、是否有火车运输、ISF相关字段禁用编辑；调整海运订单导入模版字段。

#### 12.2 需求点拆解

| 序号 | 场景 | 粒度 | 需求点 | 其他说明 |
|------|------|------|--------|----------|
| 12.2.1 | 打开海运订单详情页时 | 页面展示 | 船名航次字段禁用编辑 | 船名航次控件禁用，不支持编辑 |
| 12.2.2 | 打开海运订单详情页时 | 页面展示 | 是否有火车运输字段调整 | 调整到"海运前"模块，放在"目的港"字段后，控件禁用 |
| 12.2.3 | 打开海运订单详情页时 | 页面展示 | 提供PU密码时间显示 | 是否有火车运输为"是"时显示"提供PU密码"时间，为"否"时不显示 |
| 12.2.4 | 打开海运订单详情页时 | 页面展示 | ISF代理简称字段调整 | 调整到"海运前"模块，放在"实际离港日ATD"字段后，控件禁用 |
| 12.2.5 | 打开海运订单详情页时 | 页面展示 | ISF字段调整 | 调整到"海运前"模块，放在"ISF代理简称"字段后，控件禁用 |
| 12.2.6 | 打开海运订单详情页时 | 页面展示 | 清关代理简称字段保持不变 | 位置保持不变，海运订单管理仍支持编辑 |
| 12.2.7 | 导入模板下载时 | 页面展示 | 海运订单导入去掉船名航次 | Excel模版去掉"船名航次"字段 |
| 12.2.8 | 导入模板下载时 | 页面展示 | 海运订单导入去掉ISF代理简称 | Excel模版去掉"ISF代理简称"字段 |
| 12.2.9 | 导入模板下载时 | 页面展示 | 海运订单导入去掉ISF | Excel模版去掉"ISF"字段 |
| 12.2.10 | 导入模板下载时 | 页面展示 | 海运订单导入去掉是否有火车运输 | Excel模版去掉"是否有火车运输"字段 |
| 12.2.11 | 导入模板下载时 | 页面展示 | 海运订单导入增加订单标签 | Excel模版增加"订单标签"字段，放在"还箱点"字段后 |
| 12.2.12 | 导入模板下载时 | 页面展示 | 海运订单导入增加备注字段 | Excel模版增加"起运港备注"、"清关备注"、"目的港备注"字段，放在"还箱点"字段后 |
| 12.2.13 | 选择导入方式时 | 点击操作 | 海运订单导入支持追加/覆盖 | 订单标签、备注字段支持追加或覆盖导入 |

#### 12.3 需求点实现方案

**12.2.1-12.2.5 字段位置和编辑权限调整**

修改`MarineOrderController.findMarineOrderById()`方法（第372行），调整返回字段顺序，将trainFlag、isfAgentId、isfFlag放在海运前模块对应位置。此修改会影响海运订单详情页的展示和保存逻辑。

**12.2.3 提供PU密码时间显示**

修改`MarineOrderController.findMarineOrderById()`方法（第372行），返回puTime字段；前端判断是否展示，需要注意保存接口兼容。

**12.2.6 清关代理简称字段保持不变**

customsClearAgentId的位置和编辑权限保持现有逻辑不变，无需修改。此字段在海运订单管理仍支持编辑。

**12.2.7-12.2.10 导入模版去掉字段**

修改海运订单导入的Excel模版，去掉"船名航次"、"ISF代理简称"、"ISF"、"是否有火车运输"字段。修改对应的导入解析逻辑（需定位具体方法），不再解析这些字段。此修改需要同步更新模版下载和上传解析逻辑。

**12.2.11-12.2.12 导入模版增加字段**

修改海运订单导入的Excel模版，增加"订单标签"、"起运港备注"、"清关备注"、"目的港备注"字段，放在"还箱点"字段后。修改对应的导入解析逻辑，解析这些新字段并保存到数据库。模版中需添加字段说明。

**12.2.13 导入支持追加/覆盖**

前端在导入弹窗中增加导入方式选择（追加/覆盖）。修改海运订单导入接口，根据导入方式参数，决定是追加还是覆盖标签和备注字段。处理逻辑与订舱模块导入相同。

#### 12.4 其他注意事项
- 海运订单详情页字段调整需与订舱详情页保持一致的展示逻辑
- 海运订单导入模版调整需与订舱导入保持一致的字段格式
- 导入模版修改需同步更新下载和上传的解析逻辑
- 清关代理简称在海运订单管理仍支持编辑，需确保保存逻辑正确
- 字段禁用编辑后，前端需做好样式处理（置灰、不可点击等）

---

## 三、历史数据迁移方案

### 3.1 物流备注字段拆分

线上已有的`logistics_note`字段值需要业务进行拆分，拆分到`departure_port_note`、`destination_port_note`、`customs_clear_note`三个新字段。

**迁移步骤**：
1. 业务确认线上数据拆分规则
2. 编写数据迁移脚本，根据拆分规则将`logistics_note`字段值拆分到三个新字段
3. 在测试环境执行迁移脚本，验证数据正确性
4. 在生产环境执行迁移脚本

**迁移脚本示例**（需根据业务确认的拆分规则调整）：
```sql
-- 示例：将logistics_note全部迁移到departure_port_note
UPDATE t_marine_order
SET departure_port_note = logistics_note
WHERE logistics_note IS NOT NULL AND logistics_note != '';
```

### 3.2 订单标签数据迁移

订单标签数据保存在`r_label_order`表中，无需迁移。

### 3.3 新增字段默认值

新增字段默认值：
- `train_flag`：默认为0（否），存储在 t_marine_order_attach 表
- `isf_agent_id`：默认为NULL
- `isf_flag`：默认为NULL，存储在 t_marine_order 表
- `customs_clear_agent_id`：默认为NULL
- `departure_port_note`：默认为NULL
- `destination_port_note`：默认为NULL
- `customs_clear_note`：默认为NULL

---

## 四、接口设计

### 4.1 批量直接取消订单

**接口名称**：批量直接取消订单
**接口路径**：POST /api/shippingSpace/batchDirectCancel
**接口说明**：批量直接取消订单，无需发送邮件

**请求参数**：

| 参数名 | 类型 | 必填 | 说明                                  |
|-------|------|-----|-------------------------------------|
| shippingSpaceIds | List<Long> | 是 | 订舱ID列表                              |
| tabType | String | 是 | tab类型（unfinished/finished/abnormal） |

**请求示例**：
```json
{
  "shippingSpaceIds": [1001, 1002],
  "tabType": "unfinished"
}
```

**响应参数**：

| 参数名 | 类型 | 说明 |
|-------|------|------|
| code | Integer | 状态码 |
| message | String | 提示信息 |
| data | Object | 返回数据 |

**响应示例**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "successCount": 2,
    "failCount": 0,
    "failList": []
  }
}
```

**错误码**：

| 错误码 | 说明 |
|-------|------|
| 400 | 参数错误 |
| 401 | 无权限 |
| 500 | 系统错误 |

---

### 4.2 批量发送取消邮件(错误：基于原先单个取消发邮件方法：sendCancelMail的参数兼容批量的功能)

**接口名称**：批量发送取消邮件
**接口路径**：POST /api/shippingSpace/batchSendCancelMail
**接口说明**：批量发送取消订舱邮件

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|-----|------|
| orderIds | List<Long> | 是 | 订单ID列表 |
| tabType | String | 是 | tab类型（unfinished/finished） |
| mailSubject | String | 是 | 邮件主题                       |
| mailContent | String | 是 | 邮件正文                       |
| ccEmails | List<String> | 否 | 抄送人邮箱列表                    |
| attachmentUrls | List<String> | 否 | 附件URL列表                    |

**请求示例**：
```json
{
  "orderIds": [1001, 1002],
  "tabType": "unfinished",
  "mailSubject": "B2B美国-取消订舱2025-01-06测试代理",
  "mailContent": "Hi 测试代理 Team,\n\n以下入库单请取消订舱，谢谢！",
  "ccEmails": ["test@example.com"],
  "attachmentUrls": []
}
```

**响应参数**：

| 参数名 | 类型 | 说明 |
|-------|------|------|
| code | Integer | 状态码 |
| message | String | 提示信息 |
| data | Object | 返回数据 |

**响应示例**：
```json
{
  "code": 200,
  "message": "邮件已提交，后台正在投递中；可稍后刷新页面查看是否发送成功！",
  "data": null
}
```

**错误码**：

| 错误码 | 说明 |
|-------|------|
| 400 | 参数错误 |
| 401 | 无权限 |
| 500 | 系统错误 |

---

### 4.3 批量添加标签

**接口名称**：批量添加标签
**接口路径**：POST /api/shippingSpace/batchAddLabel
**接口说明**：批量添加订单标签

**请求参数**：

| 参数名 | 类型 | 必填 | 说明                             |
|-------|------|-----|--------------------------------|
| marineOrderIds | List<Long> | 是 | 订单ID列表                         |
| labelIds | List<Long> | 是 | 标签ID列表                         |
| batchFlag | Boolean | 是 | 批量标识（true-批量添加标签，false-单个添加标签） |

**请求示例**：
```json
{
  "marineOrderIds": [1001, 1002],
  "labelIds": [1, 2, 3],
  "batchFlag": true
}
```

**响应参数**：

| 参数名 | 类型 | 说明 |
|-------|------|------|
| code | Integer | 状态码 |
| message | String | 提示信息 |
| data | Object | 返回数据 |

**响应示例**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": null
}
```

**错误码**：

| 错误码 | 说明 |
|-------|------|
| 400 | 参数错误 |
| 401 | 无权限 |
| 500 | 系统错误 |

---

### 4.4 批量删除标签(错误：批量删除标签之前，缺少根据标签条件查询删选可删除标签订单)

**接口名称**：批量删除标签
**接口路径**：POST /api/shippingSpace/batchDeleteLabel
**接口说明**：批量删除订单标签

**请求参数**：

| 参数名 | 类型 | 必填 | 说明     |
|-------|------|-----|--------|
| labelIds | List<Long> | 是 | 标签ID列表 |
| marineOrderIds | List<Long> | 是 | 订单ID列表 |

**请求示例**：
```json
{
  "labelIds": [1, 2],
  "marineOrderIds": [1001, 1002, 1003]
}
```

**响应参数**：

| 参数名 | 类型 | 说明 |
|-------|------|------|
| code | Integer | 状态码 |
| message | String | 提示信息 |
| data | Object | 返回数据 |

**响应示例**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": null
}
```

**错误码**：

| 错误码 | 说明 |
|-------|------|
| 400 | 参数错误 |
| 401 | 无权限 |
| 500 | 系统错误 |

---

### 4.5 批量忽略异常

**接口名称**：批量忽略异常
**接口路径**：POST /api/shippingSpace/batchIgnoreAbnormal
**接口说明**：批量忽略订单异常

**请求参数**：

请求体为 JSON 数组，每个元素包含以下字段：

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|-----|------|
| shippingSpaceId | Long | 是 | 订舱ID |
| destinationPort | String | 否 | 目的港（若需补录） |

**请求示例**：
```json
[
  {
    "shippingSpaceId":1001,
    "destinationPort":"洛杉矶"
  },
  {
    "shippingSpaceId":1002,
    "destinationPort":"旧金山"
  }
]
```

**响应参数**：

| 参数名 | 类型 | 说明 |
|-------|------|------|
| code | Integer | 状态码 |
| message | String | 提示信息 |
| data | Object | 返回数据 |

**响应示例**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "successCount": 2,
    "failCount": 0,
    "failList": []
  }
}
```

**错误码**：

| 错误码 | 说明 |
|-------|------|
| 400 | 参数错误 |
| 401 | 无权限 |
| 500 | 系统错误 |

---

### 4.6 保存物流备注

**接口名称**：保存物流备注
**接口路径**：POST /api/shippingSpace/saveLogisticsNote
**接口说明**：保存订单物流备注

**请求参数**：

| 参数名 | 类型 | 必填 | 说明    |
|-------|------|-----|-------|
| marineOrderId | Long | 是 | 订单ID  |
| departurePortNote | String | 否 | 起运港备注 |
| destinationPortNote | String | 否 | 目的港备注 |
| customsClearNote | String | 否 | 清关备注  |

**请求示例**：
```json
{
  "marineOrderId": 1001,
  "departurePortNote": "起运港备注内容",
  "destinationPortNote": "目的港备注内容",
  "customsClearNote": "清关备注内容"
}
```

**响应参数**：

| 参数名 | 类型 | 说明 |
|-------|------|------|
| code | Integer | 状态码 |
| message | String | 提示信息 |
| data | Object | 返回数据 |

**响应示例**：
```json
{
  "code": 200,
  "message": "保存成功",
  "data": null
}
```

**错误码**：

| 错误码 | 说明 |
|-------|------|
| 400 | 参数错误 |
| 401 | 无权限 |
| 500 | 系统错误 |

---

### 4.7 获取海运前明细信息

**接口名称**：获取海运前明细信息
**接口路径**：GET /api/shippingSpace/getPreShippingInfo/{shippingSpaceId}
**接口说明**：获取订单海运前明细信息

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|-----|------|
| shippingSpaceId | Long | 是 | 订舱ID |

**响应参数**：

| 参数名 | 类型 | 说明 |
|-------|------|------|
| code | Integer | 状态码 |
| message | String | 提示信息 |
| data | Object | 海运前明细数据 |

data 对象字段与 4.8 保存接口请求体保持一致：

| 字段名 | 类型 | 说明 |
|-------|------|------|
| shippingSpaceId | Long | 订舱ID |
| planShipStartDate | String | 预计发船周期开始时间 |
| planShipEndDate | String | 预计发船周期结束时间 |
| portOfDeparture | String | 起运港 |
| equipmentCode | String | 箱型 |
| agentName | String | 货运代理简称 |
| releaseCabinTime | String | 放舱时间 |
| firstEtdDate | String | 首次ETD |
| carrier | String | 船公司 |
| mbl | String | 提单号 |
| voyageType | String | 航程类型 |
| transportVesselName | String | 船名航次 |
| cutoffDate | String | 截单时间 |
| estimateDepartureTime | String | 预计离港日ETD |
| estimateArrivalTime | String | 预计到港日ETA |
| portOfDestination | String | 目的港 |
| trainFlag | Integer | 是否有火车运输 |
| container | String | 集装箱号 |
| weight | BigDecimal | 货重 |
| enterPortDate | String | 实际进港日 |
| actualDepartureTime | String | 实际离港日ATD |
| isfAgentId | Integer | ISF代理简称ID |
| isfAgentName | String | ISF代理简称 |
| isfFlag | String | ISF |
| customsClearAgentId | Integer | 清关代理简称ID |
| customsClearAgentName | String | 清关代理简称 |
| agentGiveTelexRelease | Boolean | 客户放行 |
| hasForwarderReleaseFlag | Boolean | 货代放行 |

**响应示例**：
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "shippingSpaceId": 1001,
    "planShipStartDate": "2025-01-01",
    "planShipEndDate": "2025-01-07",
    "portOfDeparture": "上海",
    "equipmentCode": "20GP",
    "agentName": "测试货代",
    "releaseCabinTime": "2025-01-06 10:00:00",
    "firstEtdDate": "2025-01-15",
    "carrier": "测试船公司",
    "mbl": "TEST123456",
    "voyageType": "直达",
    "transportVesselName": "测试船名/航次",
    "cutoffDate": "2025-01-10 18:00:00",
    "estimateDepartureTime": "2025-01-15 12:00:00",
    "estimateArrivalTime": "2025-01-25 08:00:00",
    "portOfDestination": "洛杉矶",
    "trainFlag": 1,
    "container": "CONT123456",
    "weight": 1000.5,
    "enterPortDate": "2025-01-12",
    "actualDepartureTime": "2025-01-16 03:00:00",
    "isfAgentId": 2001,
    "isfAgentName": "测试ISF代理",
    "isfFlag": "已提供",
    "customsClearAgentId": 3001,
    "customsClearAgentName": "测试清关代理",
    "agentGiveTelexRelease": true,
    "hasForwarderReleaseFlag": true
  }
}
```

**错误码**：

| 错误码 | 说明 |
|-------|------|
| 400 | 参数错误 |
| 401 | 无权限 |
| 500 | 系统错误 |

---

### 4.8 保存海运前明细信息

**接口名称**：保存海运前明细信息
**接口路径**：POST /api/shippingSpace/savePreShippingInfo
**接口说明**：保存订单海运前明细信息

**请求参数**：

| 参数名 | 类型     | 必填 | 说明         |
|-------|--------|----|------------|
| shippingSpaceId | Long   | 是  | 订舱ID       |
| planShipStartDate | String | 是  | 预计发船周期开始时间 |
| planShipEndDate | String | 是  | 预计发船周期结束时间 |
| portOfDeparture | String | 是  | 起运港        |
| equipmentCode | String | 是  | 箱型         |
| agentName | String | 是  | 货运代理简称     |
| releaseCabinTime | String | 否  | 放舱时间       |
| firstEtdDate | String | 否  | 首次ETD      |
| carrier | String | 是  | 船公司        |
| mbl | String | 是  | 提单号        |
| voyageType | String | 是  | 航程类型       |
| transportVesselName | String | 是  | 船名航次       |
| cutoffDate | String | 是  | 截单时间       |
| estimateDepartureTime | String | 是  | 预计离港日ETD   |
| estimateArrivalTime | String | 是  | 预计到港日ETA   |
| portOfDestination | String | 是  | 目的港        |
| trainFlag | Integer | 是  | 是否有火车运输    |
| container | String | 否  | 集装箱号       |
| weight | BigDecimal | 否  | 货重         |
| enterPortDate | String | 否  | 实际进港日      |
| actualDepartureTime | String | 否  | 实际离港日ATD   |
| isfAgentId | Integer | 否  | ISF代理简称ID  |
| isfAgentName | String | 否  | ISF代理简称    |
| isfFlag | String | 否  | ISF        |
| customsClearAgentId | Integer | 否  | 清关代理简称ID   |
| customsClearAgentName | String | 否  | 清关代理简称     |
| agentGiveTelexRelease | Boolean       | 否  | 客户放行       |
| hasForwarderReleaseFlag | Boolean | 否  | 货代放行       |

**请求示例**：
```json
{
  "shippingSpaceId": 1001,
  "planShipStartDate": "2025-01-01",
  "planShipEndDate": "2025-01-07",
  "portOfDeparture": "上海",
  "equipmentCode": "20GP",
  "agentName": "测试货代",
  "releaseCabinTime": "2025-01-06 10:00:00",
  "firstEtdDate": "2025-01-15",
  "carrier": "测试船公司",
  "mbl": "TEST123456",
  "voyageType": "直达",
  "transportVesselName": "测试船名/航次",
  "cutoffDate": "2025-01-10 18:00:00",
  "estimateDepartureTime": "2025-01-15 12:00:00",
  "estimateArrivalTime": "2025-01-25 08:00:00",
  "portOfDestination": "洛杉矶",
  "trainFlag": 1,
  "container": "CONT123456",
  "weight": 1000.5,
  "enterPortDate": "2025-01-12",
  "actualDepartureTime": "2025-01-16 03:00:00",
  "isfAgentId": 2001,
  "isfAgentName": "测试ISF代理",
  "isfFlag": "已提供",
  "customsClearAgentId": 3001,
  "customsClearAgentName": "测试清关代理",
  "agentGiveTelexRelease": true,
  "hasForwarderReleaseFlag": true
}
```

**响应参数**：

| 参数名 | 类型 | 说明 |
|-------|------|------|
| code | Integer | 状态码 |
| message | String | 提示信息 |
| data | Object | 返回数据 |

**响应示例**：
```json
{
  "code": 200,
  "message": "保存成功",
  "data": null
}
```

**错误码**：

| 错误码 | 说明 |
|-------|------|
| 400 | 参数错误 |
| 401 | 无权限 |
| 500 | 系统错误 |

---

### 4.9 筛选可忽略订单

**接口名称**：筛选可忽略订单
**接口路径**：POST /api/shippingSpace/filterCanIgnoreOrders
**接口说明**：筛选可忽略异常的订单

**响应参数**：

| 参数名 | 类型 | 说明 |
|-------|------|------|
| code | Integer | 状态码 |
| message | String | 提示信息 |
| data | Object | 返回数据 |

**响应示例**：
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "shippingSpaceIds": [1001, 1002, 1003]
  }
}
```

**错误码**：

| 错误码 | 说明 |
|-------|------|
| 400 | 参数错误 |
| 401 | 无权限 |
| 500 | 系统错误 |

---

### 4.10 筛选可取消订单

**接口名称**：筛选可取消订单
**接口路径**：POST /api/shippingSpace/filterCanCancelOrders
**接口说明**：筛选可取消订舱的订单

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|-----|------|
| tabType | String | 是 | tab类型（unfinished/finished/abnormal） |

**请求示例**：
```json
{
  "tabType": "unfinished"
}
```

**响应参数**：

| 参数名 | 类型 | 说明 |
|-------|------|------|
| code | Integer | 状态码 |
| message | String | 提示信息 |
| data | Object | 返回数据 |

**响应示例**：
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "shippingSpaceIds": [1001, 1002, 1003]
  }
}
```

**错误码**：

| 错误码 | 说明 |
|-------|------|
| 400 | 参数错误 |
| 401 | 无权限 |
| 500 | 系统错误 |

---

### 4.11 补录目的港

**接口复用说明**：补录目的港功能不单独提供新接口，统一复用 **4.5 批量忽略异常** 接口：

- 接口路径：`POST /api/shippingSpace/batchIgnoreAbnormal`
- 补录目的港通过 4.5 接口请求体中每个元素的 `destinationPort` 字段完成
- 当 `destinationPort` 有值时，后台在忽略异常的同时补录目的港信息

补录目的港的前端交互与 4.5 一致，仅在调用时按需填充 `destinationPort` 字段。

---

## 五、其他注意事项

### 5.1 安全性
- 所有接口需进行权限校验，防止越权操作
- 批量操作需支持部分成功、部分失败的情况，返回详细的失败原因
- 并发操作需进行状态校验，防止数据不一致
- 批量查询需处理SQL注入风险，使用参数化查询
- 前端显示需处理特殊字符转义，防止XSS攻击

### 5.2 性能
- 批量操作需考虑性能优化，避免一次性处理过多数据
- 列表查询需考虑分页和索引优化，增加必要的数据库索引
- 标签查询需考虑缓存优化，减少数据库查询压力
- 导入功能需处理大量数据的性能问题，可考虑分批处理
- 异常记录优化需考虑批量处理场景

### 5.3 边界情况
- 订单状态变更时的并发处理
- 邮件发送失败时的异常处理
- 导入数据时的数据校验和异常处理
- 标签不存在时的处理
- 目的港失效或不匹配时的处理
- 批量查询时的空值和空列表处理
- 导入时的数据格式校验

### 5.4 兼容性
- 新增字段需考虑历史数据的兼容性
- 接口变更需考虑向后兼容性，避免破坏现有调用方
- 权限调整需考虑现有用户的兼容性，做好权限映射
- Excel导入模版变更需同步更新下载和解析逻辑
- 数据库字段变更需做好回滚方案

### 5.5 测试
- 需测试各种边界情况
- 需测试并发场景
- 需测试批量操作的性能和正确性
- 需测试权限控制的有效性
- 需测试导入功能的数据校验
- 需测试异常场景的处理逻辑
- 需测试历史数据迁移的正确性

---

## 六、总结

本技术方案涵盖了取消订舱/异常操作支持批量操作等相关优化的所有需求，包括数据库结构变动、各模块详细实现方案、历史数据迁移方案和接口设计。方案遵循了项目的代码规范，采用了标准的MVC架构，使用了MyBatis-Plus简化数据操作，通过枚举类管理状态，整体架构清晰，功能完整。

在实现过程中，需要注意以下几点：
1. 确保所有接口都有权限校验，防止越权操作
2. 批量操作需支持部分成功、部分失败的情况，返回详细的失败原因
3. 并发操作需进行状态校验，防止数据不一致
4. 历史数据迁移需在测试环境充分验证后再在生产环境执行
5. 新增字段需考虑历史数据的兼容性
6. 各模块的字段展示和编辑权限需根据国别和系统类型动态调整
7. 标签功能需与海运订单管理保持一致的数据和交互
8. 导入功能需支持追加/覆盖两种模式，并做好数据校验

本方案为开发提供了详细的指导，开发人员可以根据本方案进行开发，确保功能的正确性和完整性。
